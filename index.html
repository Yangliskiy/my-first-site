<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Lab</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #000;
            color: #ffffff;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: background 1s ease-in-out;
        }

        /* --- BACKGROUNDS GENERATED VIA CSS (NO IMAGES) --- */
        
        /* Level 0: Basement (Dark Green Toxic) */
        .bg-lvl-0 {
            background: radial-gradient(circle at 50% 30%, #14532d 0%, #020617 70%);
        }
        
        /* Level 1: Garage (Industrial Blue) */
        .bg-lvl-1 {
            background: radial-gradient(circle at 50% 30%, #1e3a8a 0%, #020617 70%);
        }

        /* Level 2: Factory (Rust Orange) */
        .bg-lvl-2 {
            background: radial-gradient(circle at 50% 30%, #7c2d12 0%, #020617 70%);
        }

        /* Level 3: High-Tech (Cyan Neon) */
        .bg-lvl-3 {
            background: radial-gradient(circle at 50% 30%, #0891b2 0%, #020617 70%);
        }

        /* Level 4: Crystal (Cosmic Purple) */
        .bg-lvl-4 {
            background: radial-gradient(circle at 50% 30%, #7e22ce 0%, #020617 70%);
        }

        /* Cyber Grid Overlay Pattern */
        .cyber-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        /* Vignette for depth */
        .vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 0%, #000000 100%);
            pointer-events: none;
            z-index: 0;
        }

        /* --- ANIMATIONS --- */

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-screen { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes liquid-pulse {
            0%, 100% { filter: drop-shadow(0 0 15px #22c55e); transform: scale(1); }
            50% { filter: drop-shadow(0 0 30px #4ade80); transform: scale(1.02); }
        }
        .flask-btn {
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: liquid-pulse 3s infinite;
        }
        .flask-btn:active { transform: scale(0.90) rotate(5deg); }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-120px) scale(1.5) rotate(10deg); }
        }
        .floating-text {
            position: absolute;
            color: #4ade80; 
            font-weight: 900;
            font-size: 28px;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            text-shadow: 0 0 10px #22c55e;
            z-index: 50;
            font-family: monospace;
        }
        .crit-text {
            color: #ef4444; 
            font-size: 42px;
            text-shadow: 0 0 15px #b91c1c;
            z-index: 60;
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 222, 128, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .no-select { user-select: none; -webkit-user-select: none; }

        .shop-grid {
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        .shop-grid::-webkit-scrollbar { display: none; }

        .tab-active {
            background-color: rgba(34, 197, 94, 0.2);
            border-bottom: 2px solid #4ade80;
            color: #4ade80;
        }
        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
    </style>
</head>
<body id="gameBody" class="h-screen w-full flex flex-col justify-between items-center p-4 bg-lvl-0">
    
    <!-- Background Effects -->
    <div class="cyber-grid"></div>
    <div class="vignette"></div>

    <!-- MAIN APP CONTENT -->
    <div class="relative z-10 w-full max-w-md flex flex-col h-full justify-between pb-2">
        
        <!-- Header: Stats -->
        <div class="w-full flex justify-between items-center glass-panel rounded-2xl p-4 mb-2 mt-2 border-l-4 border-green-500 relative overflow-hidden">
            <div class="flex flex-col relative z-10">
                <span class="text-xs text-green-400 uppercase tracking-widest font-mono">–°–∫–ª–∞–¥ (–º–≥)</span>
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded bg-green-900/50 border border-green-500 flex items-center justify-center text-xs font-bold text-green-400">‚ò£</div>
                    <span id="scoreDisplay" class="text-3xl font-mono font-bold tracking-wider text-green-300 drop-shadow-lg">0</span>
                </div>
                <div class="text-[10px] text-green-600 font-mono mt-1" id="passiveDisplay">0 –º–≥/—Å–µ–∫</div>
            </div>
            <div class="text-right relative z-10">
                <span class="text-xs text-gray-400 uppercase tracking-widest font-mono">–õ–æ–∫–∞—Ü–∏—è</span>
                <div id="levelDisplay" class="text-green-400 font-bold tracking-wide text-sm transition-all">–ü–æ–¥–≤–∞–ª</div>
                <div id="multiplierDisplay" class="text-xs text-yellow-500 font-bold mt-1 opacity-0 transition-opacity">–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x1</div>
            </div>
            
            <!-- Crit Flash Background -->
            <div id="critFlash" class="absolute inset-0 bg-red-500/20 opacity-0 pointer-events-none transition-opacity duration-100"></div>
        </div>

        <!-- Game Area: The Flask -->
        <div class="flex-grow flex items-center justify-center relative w-full perspective-container min-h-0">
            <div id="clickTarget" class="flask-btn w-64 h-64 flex items-center justify-center cursor-pointer no-select relative group tap-highlight-transparent">
                <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-[0_0_25px_rgba(74,222,128,0.6)]">
                    <defs>
                        <linearGradient id="liquidGrad" x1="0%" y1="100%" x2="0%" y2="0%">
                            <stop offset="0%" style="stop-color:#14532d;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#4ade80;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path d="M75,20 L125,20 L125,70 L160,130 C170,145 170,180 145,180 L55,180 C30,180 30,145 40,130 L75,70 Z" 
                          fill="rgba(255,255,255,0.05)" stroke="#a3e635" stroke-width="4" stroke-linejoin="round"/>
                    <path d="M80,80 L120,80 L148,130 C155,142 155,170 140,170 L60,170 C45,170 45,142 52,130 Z" 
                          fill="url(#liquidGrad)" class="opacity-90"/>
                    <circle cx="100" cy="150" r="5" fill="#fff" opacity="0.4" />
                    <circle cx="90" cy="130" r="3" fill="#fff" opacity="0.3" />
                    <circle cx="110" cy="160" r="4" fill="#fff" opacity="0.5" />
                </svg>
            </div>
        </div>

        <!-- Energy Bar -->
        <div class="w-full mb-3 px-2">
            <div class="flex justify-between text-sm mb-1 font-bold text-green-300 font-mono">
                <span>‚ö° –†–µ–∞–∫—Ç–æ—Ä</span>
                <span id="energyText">1000 / 1000</span>
            </div>
            <div class="w-full h-4 bg-black rounded border border-green-900 overflow-hidden relative">
                <div class="absolute inset-0 opacity-20 bg-[repeating-linear-gradient(45deg,transparent,transparent_10px,#000_10px,#000_20px)] z-10"></div>
                <div id="energyBar" class="h-full bg-gradient-to-r from-green-900 via-green-600 to-green-400 transition-all duration-300 relative z-0" style="width: 100%"></div>
            </div>
        </div>

        <!-- Shop / Upgrades Panel -->
        <div class="glass-panel rounded-xl flex flex-col h-[40vh] overflow-hidden">
            <!-- Tabs -->
            <div class="flex border-b border-green-800">
                <button onclick="switchTab('upgrades')" id="tabUpgrades" class="flex-1 py-3 text-sm font-bold uppercase tracking-wider transition-colors tab-active">
                    –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                </button>
                <button onclick="switchTab('blackmarket')" id="tabBlackmarket" class="flex-1 py-3 text-sm font-bold uppercase tracking-wider transition-colors tab-inactive flex items-center justify-center gap-2">
                    –ß–µ—Ä–Ω—ã–π –†—ã–Ω–æ–∫ <span class="text-xs bg-red-900 text-red-200 px-1 rounded animate-pulse">!</span>
                </button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto shop-grid p-2 relative">
                <!-- UPGRADES TAB -->
                <div id="contentUpgrades" class="space-y-2">
                    
                    <!-- NEW: LOCATION UPGRADE BUTTON -->
                    <button onclick="buyUpgrade('location')" id="btnLocation" class="w-full group relative overflow-hidden bg-gradient-to-r from-green-900/60 to-blue-900/60 border border-white/20 hover:border-white/50 active:scale-95 rounded-xl p-3 text-left transition-all shadow-lg mb-4">
                        <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition"></div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">üèóÔ∏è</div>
                                <div>
                                    <div class="text-xs text-white uppercase font-bold tracking-widest">–ü–µ—Ä–µ–µ–∑–¥</div>
                                    <div class="text-[10px] text-gray-300 font-mono">–°–º–µ–Ω–∏—Ç—å –õ–æ–∫–∞—Ü–∏—é (–î–æ—Ö–æ–¥ x2)</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-mono text-white text-xs font-bold" id="nextLocName">–ì–∞—Ä–∞–∂</div>
                                <div class="text-green-400 text-xs font-mono mt-1 font-bold" id="costLocation">5,000 –º–≥</div>
                            </div>
                        </div>
                    </button>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="buyUpgrade('multitap')" class="group relative overflow-hidden bg-black/40 hover:bg-green-900/30 active:bg-green-900/50 border border-green-800 rounded-lg p-2 text-left transition-all h-24 flex flex-col justify-between">
                            <div class="flex justify-between items-start">
                                <div class="text-[10px] text-green-500 uppercase font-bold tracking-widest">–°–∏–Ω—Ç–µ–∑</div>
                                <div class="text-xl opacity-50">‚öóÔ∏è</div>
                            </div>
                            <div>
                                <div class="font-mono text-white text-xs">–£—Ä. <span id="lvlMultitap" class="text-green-300">1</span></div>
                                <div class="text-gray-400 text-[10px] font-mono mt-1" id="costMultitap">100 –º–≥</div>
                            </div>
                        </button>
                        <button onclick="buyUpgrade('energy')" class="group relative overflow-hidden bg-black/40 hover:bg-purple-900/30 active:bg-purple-900/50 border border-purple-900 rounded-lg p-2 text-left transition-all h-24 flex flex-col justify-between">
                            <div class="flex justify-between items-start">
                                <div class="text-[10px] text-purple-400 uppercase font-bold tracking-widest">–ï–º–∫–æ—Å—Ç—å</div>
                                <div class="text-xl opacity-50">üîã</div>
                            </div>
                            <div>
                                <div class="font-mono text-white text-xs">–£—Ä. <span id="lvlEnergy" class="text-purple-300">1</span></div>
                                <div class="text-gray-400 text-[10px] font-mono mt-1" id="costEnergy">100 –º–≥</div>
                            </div>
                        </button>
                        <button onclick="buyUpgrade('recharge')" class="group relative overflow-hidden bg-black/40 hover:bg-blue-900/30 active:bg-blue-900/50 border border-blue-900 rounded-lg p-2 text-left transition-all h-24 flex flex-col justify-between">
                            <div class="flex justify-between items-start">
                                <div class="text-[10px] text-blue-400 uppercase font-bold tracking-widest">–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ</div>
                                <div class="text-xl opacity-50">‚ùÑÔ∏è</div>
                            </div>
                            <div>
                                <div class="font-mono text-white text-xs">–£—Ä. <span id="lvlRecharge" class="text-blue-300">1</span></div>
                                <div class="text-gray-400 text-[10px] font-mono mt-1" id="costRecharge">100 –º–≥</div>
                            </div>
                        </button>
                        <button onclick="buyUpgrade('autobot')" class="group relative overflow-hidden bg-black/40 hover:bg-yellow-900/30 active:bg-yellow-900/50 border border-yellow-700 rounded-lg p-2 text-left transition-all h-24 flex flex-col justify-between">
                            <div class="flex justify-between items-start">
                                <div class="text-[10px] text-yellow-500 uppercase font-bold tracking-widest">–ê–≤—Ç–æ-–í–∞—Ä–∫–∞</div>
                                <div class="text-xl opacity-50">ü§ñ</div>
                            </div>
                            <div>
                                <div class="font-mono text-white text-xs">–£—Ä. <span id="lvlAutobot" class="text-yellow-300">0</span></div>
                                <div class="text-gray-400 text-[10px] font-mono mt-1" id="costAutobot">500 –º–≥</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- BLACK MARKET TAB -->
                <div id="contentBlackmarket" class="hidden space-y-3">
                    <div class="text-xs text-red-500 uppercase tracking-widest text-center mb-2 font-bold border-b border-red-900/30 pb-1">–û—Å–æ–±–æ –û–ø–∞—Å–Ω—ã–µ –í–µ—â–µ—Å—Ç–≤–∞</div>
                    <button onclick="buyItem('unstableIsotope')" id="btnIsotope" class="w-full group relative overflow-hidden bg-red-900/10 border border-red-800/50 hover:bg-red-900/20 active:scale-95 rounded-lg p-3 text-left transition-all flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-red-900/30 flex items-center justify-center text-xl">‚ò¢Ô∏è</div>
                            <div>
                                <div class="text-xs text-red-400 uppercase font-bold">–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ò–∑–æ—Ç–æ–ø</div>
                                <div class="text-[10px] text-gray-500">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∞–∫—Ü–∏–∏ (x5)</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-red-300 text-xs font-mono font-bold" id="costIsotope">2,500 –º–≥</div>
                            <div id="statusIsotope" class="text-[10px] text-green-500 font-bold hidden">–ö–£–ü–õ–ï–ù–û</div>
                        </div>
                    </button>
                    <button onclick="buyItem('blueCrystal')" id="btnCrystal" class="w-full group relative overflow-hidden bg-cyan-900/10 border border-cyan-800/50 hover:bg-cyan-900/20 active:scale-95 rounded-lg p-3 text-left transition-all flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-cyan-900/30 flex items-center justify-center text-xl">üíé</div>
                            <div>
                                <div class="text-xs text-cyan-400 uppercase font-bold">–°–∏–Ω–∏–π –ö—Ä–∏—Å—Ç–∞–ª–ª</div>
                                <div class="text-[10px] text-gray-500">–£–¥–≤–∞–∏–≤–∞–µ—Ç –¥–æ–±—ã—á—É (x2)</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-cyan-300 text-xs font-mono font-bold" id="costCrystal">10,000 –º–≥</div>
                            <div id="statusCrystal" class="text-[10px] text-green-500 font-bold hidden">–ö–£–ü–õ–ï–ù–û</div>
                        </div>
                    </button>
                     <button onclick="buyItem('darkMatter')" id="btnDarkMatter" class="w-full group relative overflow-hidden bg-fuchsia-900/10 border border-fuchsia-800/50 hover:bg-fuchsia-900/20 active:scale-95 rounded-lg p-3 text-left transition-all flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded bg-fuchsia-900/30 flex items-center justify-center text-xl">üåå</div>
                            <div>
                                <div class="text-xs text-fuchsia-400 uppercase font-bold">–¢–µ–º–Ω–∞—è –ú–∞—Ç–µ—Ä–∏—è</div>
                                <div class="text-[10px] text-gray-500">–ú—É—Ç–∞—Ü–∏—è (x5 –∫–æ –≤—Å–µ–º—É)</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-fuchsia-300 text-xs font-mono font-bold" id="costDarkMatter">100,000 –º–≥</div>
                            <div id="statusDarkMatter" class="text-[10px] text-green-500 font-bold hidden">–ö–£–ü–õ–ï–ù–û</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-900/90 border border-red-500 text-red-100 px-6 py-3 rounded shadow-[0_0_20px_rgba(239,68,68,0.5)] opacity-0 transition-opacity duration-300 z-50 pointer-events-none text-sm font-bold font-mono tracking-wide uppercase">
        –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—ã—Ä—å—è!
    </div>

    <script>
        // --- Game Config & State ---
        const GameState = {
            balance: 0,
            energy: 1000,
            maxEnergy: 1000,
            energyRechargeRate: 3, 
            multitapLevel: 1,
            energyLevel: 1,
            rechargeLevel: 1,
            autobotLevel: 0,
            locationLevel: 0, // 0 to 4
            hasCrit: false,
            multiplier: 1, 
            items: {
                unstableIsotope: false,
                blueCrystal: false,
                darkMatter: false
            },
            lastSaveTime: Date.now()
        };

        const LocationNames = ["–ü–æ–¥–≤–∞–ª", "–ì–∞—Ä–∞–∂", "–ó–∞–≤–æ–¥", "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", "–ö–æ—Å–º–æ—Å"];

        const Upgrades = {
            multitap: { baseCost: 100, costMultiplier: 2.0, powerBase: 1 },
            energy: { baseCost: 100, costMultiplier: 1.5, powerBase: 500 },
            recharge: { baseCost: 300, costMultiplier: 1.8, powerBase: 1 }, 
            autobot: { baseCost: 500, costMultiplier: 2.5, powerBase: 1 },
            location: { baseCost: 5000, costMultiplier: 5.0, powerBase: 1 } // Expensive!
        };

        const SpecialItems = {
            unstableIsotope: { cost: 2500, name: "–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ò–∑–æ—Ç–æ–ø" },
            blueCrystal: { cost: 10000, name: "–°–∏–Ω–∏–π –ö—Ä–∏—Å—Ç–∞–ª–ª" },
            darkMatter: { cost: 100000, name: "–¢–µ–º–Ω–∞—è –ú–∞—Ç–µ—Ä–∏—è" }
        };

        let currentBgLevel = -1;

        const tg = window.Telegram.WebApp;
        
        function initTelegram() {
            tg.expand();
            tg.ready();
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#000000');
        }

        // --- Core Logic ---

        function loadGame() {
            const saved = localStorage.getItem('neonLabSave_v8'); 
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(GameState, parsed);
                
                // Ensure locationLevel exists (migration)
                if(typeof GameState.locationLevel === 'undefined') GameState.locationLevel = 0;

                recalcMultiplier();

                const now = Date.now();
                const secondsPassed = (now - GameState.lastSaveTime) / 1000;
                
                const regained = Math.floor(secondsPassed * GameState.energyRechargeRate);
                GameState.energy = Math.min(GameState.maxEnergy, GameState.energy + regained);

                if (GameState.autobotLevel > 0 && secondsPassed > 0) {
                    const baseEarn = GameState.autobotLevel * Upgrades.autobot.powerBase;
                    const finalEarn = Math.floor(baseEarn * GameState.multiplier * secondsPassed);
                    if (finalEarn > 0) {
                        GameState.balance += finalEarn;
                        setTimeout(() => showToast(`–û—Ñ–ª–∞–π–Ω: +${finalEarn.toLocaleString()} –º–≥`), 500);
                    }
                }
            }
            updateUI();
        }

        function recalcMultiplier() {
            let mult = 1;
            // Shop items
            if(GameState.items.blueCrystal) mult *= 2;
            if(GameState.items.darkMatter) mult *= 5;
            
            // Location Bonus (x2 per level, starting from level 1. Level 0 is x1 base)
            // Example: Lvl 0 = x1, Lvl 1 = x2, Lvl 2 = x4? Or just linear?
            // Let's make it impactful: x2 for every level above 0.
            // Level 0: x1
            // Level 1: x2
            // Level 2: x4
            // Level 3: x8
            if (GameState.locationLevel > 0) {
                mult *= Math.pow(2, GameState.locationLevel);
            }

            GameState.multiplier = mult;
        }

        function saveGame() {
            GameState.lastSaveTime = Date.now();
            localStorage.setItem('neonLabSave_v8', JSON.stringify(GameState));
        }

        function getClickPower() {
            return GameState.multitapLevel * GameState.multiplier; 
        }

        function getUpgradeCost(type) {
            let level = 1;
            if (type === 'multitap') level = GameState.multitapLevel;
            if (type === 'energy') level = GameState.energyLevel;
            if (type === 'recharge') level = GameState.rechargeLevel;
            if (type === 'autobot') level = GameState.autobotLevel + 1;
            if (type === 'location') level = GameState.locationLevel + 1;

            const config = Upgrades[type];
            return Math.floor(config.baseCost * Math.pow(config.costMultiplier, level - 1));
        }

        // --- Tabs ---
        function switchTab(tabName) {
            const btnUp = document.getElementById('tabUpgrades');
            const btnBm = document.getElementById('tabBlackmarket');
            const contentUp = document.getElementById('contentUpgrades');
            const contentBm = document.getElementById('contentBlackmarket');

            if (tabName === 'upgrades') {
                btnUp.classList.add('tab-active'); btnUp.classList.remove('tab-inactive');
                btnBm.classList.add('tab-inactive'); btnBm.classList.remove('tab-active');
                contentUp.classList.remove('hidden');
                contentBm.classList.add('hidden');
            } else {
                btnBm.classList.add('tab-active'); btnBm.classList.remove('tab-inactive');
                btnUp.classList.add('tab-inactive'); btnUp.classList.remove('tab-active');
                contentBm.classList.remove('hidden');
                contentUp.classList.add('hidden');
            }
        }

        // --- Interaction ---

        const clickTarget = document.getElementById('clickTarget');

        clickTarget.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            if (GameState.energy >= 1) {
                handleTap(e);
            } else {
                clickTarget.style.transform = "translateX(5px) rotate(5deg)";
                setTimeout(() => clickTarget.style.transform = "translateX(-5px) rotate(-5deg)", 50);
                setTimeout(() => clickTarget.style.transform = "none", 100);
                tg.HapticFeedback.notificationOccurred('error');
            }
        });

        function handleTap(e) {
            let power = getClickPower();
            
            let isCrit = false;
            if (GameState.items.unstableIsotope && Math.random() < 0.1) {
                isCrit = true;
                power *= 5;
                tg.HapticFeedback.notificationOccurred('warning');
                triggerCritEffect();
            } else {
                tg.HapticFeedback.impactOccurred('heavy');
            }
            
            if (GameState.energy < GameState.multitapLevel) return;

            GameState.balance += power;
            GameState.energy -= GameState.multitapLevel;
            
            const rect = clickTarget.getBoundingClientRect();
            const x = e.clientX - rect.left - rect.width / 2;
            const y = e.clientY - rect.top - rect.height / 2;
            
            clickTarget.style.transform = `scale(0.95) rotate(${x/10}deg)`;
            setTimeout(() => {
                clickTarget.style.transform = 'scale(1) rotate(0deg)';
            }, 100);

            createFloatingText(e.clientX, e.clientY, `+${Math.floor(power)}`, isCrit);
            updateUI();
        }

        function triggerCritEffect() {
            const body = document.getElementById('gameBody');
            const flash = document.getElementById('critFlash');
            body.classList.add('shake-screen');
            flash.style.opacity = '1';
            setTimeout(() => {
                body.classList.remove('shake-screen');
                flash.style.opacity = '0';
            }, 300);
        }

        function createFloatingText(x, y, text, isCrit) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            if (isCrit) {
                el.className += ' crit-text';
                el.innerText = "CRIT " + text + "!";
            } else {
                el.innerText = text;
            }
            const randomX = (Math.random() - 0.5) * 40;
            el.style.left = `${x + randomX}px`;
            el.style.top = `${y}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // --- Shop Actions ---

        window.buyUpgrade = function(type) {
            const cost = getUpgradeCost(type);
            
            if (type === 'location' && GameState.locationLevel >= 4) {
                 showToast("–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –£–†–û–í–ï–ù–¨!");
                 return;
            }

            if (GameState.balance >= cost) {
                GameState.balance -= cost;
                
                if (type === 'multitap') GameState.multitapLevel++;
                else if (type === 'energy') {
                    GameState.energyLevel++;
                    GameState.maxEnergy += Upgrades.energy.powerBase;
                    GameState.energy = GameState.maxEnergy;
                }
                else if (type === 'recharge') {
                    GameState.rechargeLevel++;
                    GameState.energyRechargeRate += Upgrades.recharge.powerBase;
                }
                else if (type === 'autobot') GameState.autobotLevel++;
                else if (type === 'location') {
                    GameState.locationLevel++;
                    recalcMultiplier();
                    showToast(`–ü–ï–†–ï–ï–ó–î: ${LocationNames[GameState.locationLevel]}`);
                }
                
                tg.HapticFeedback.notificationOccurred('success');
                saveGame();
                updateUI();
            } else {
                showToast("–ù–ï –•–í–ê–¢–ê–ï–¢ –°–´–†–¨–Ø!");
                tg.HapticFeedback.notificationOccurred('warning');
            }
        };

        window.buyItem = function(itemKey) {
            if (GameState.items[itemKey]) return;
            const item = SpecialItems[itemKey];
            if (GameState.balance >= item.cost) {
                GameState.balance -= item.cost;
                GameState.items[itemKey] = true;
                recalcMultiplier();

                tg.HapticFeedback.notificationOccurred('success');
                showToast("–í–ï–©–ï–°–¢–í–û –°–ò–ù–¢–ï–ó–ò–†–û–í–ê–ù–û!");
                saveGame();
                updateUI();
            } else {
                showToast("–ù–ï –•–í–ê–¢–ê–ï–¢ –°–´–†–¨–Ø!");
                tg.HapticFeedback.notificationOccurred('warning');
            }
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        }

        // --- UI Updates ---

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = Math.floor(GameState.balance).toLocaleString();
            
            const passiveRate = GameState.autobotLevel * Upgrades.autobot.powerBase * GameState.multiplier;
            document.getElementById('passiveDisplay').innerText = passiveRate > 0 ? `+${passiveRate} –º–≥/—Å–µ–∫` : "0 –º–≥/—Å–µ–∫";

            const multDisplay = document.getElementById('multiplierDisplay');
            if (GameState.multiplier > 1) {
                multDisplay.style.opacity = '1';
                multDisplay.innerText = `–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x${GameState.multiplier}`;
            }

            const pct = (GameState.energy / GameState.maxEnergy) * 100;
            const energyBar = document.getElementById('energyBar');
            energyBar.style.width = `${pct}%`;
            if(pct < 20) {
                energyBar.classList.remove('from-green-900', 'to-green-400');
                energyBar.classList.add('bg-red-600');
            } else {
                energyBar.classList.add('from-green-900', 'to-green-400');
                energyBar.classList.remove('bg-red-600');
            }
            document.getElementById('energyText').innerText = `${Math.floor(GameState.energy)} / ${GameState.maxEnergy}`;

            document.getElementById('lvlMultitap').innerText = GameState.multitapLevel;
            document.getElementById('costMultitap').innerText = getUpgradeCost('multitap').toLocaleString() + ' –º–≥';
            document.getElementById('lvlEnergy').innerText = GameState.energyLevel;
            document.getElementById('costEnergy').innerText = getUpgradeCost('energy').toLocaleString() + ' –º–≥';
            document.getElementById('lvlRecharge').innerText = GameState.rechargeLevel;
            document.getElementById('costRecharge').innerText = getUpgradeCost('recharge').toLocaleString() + ' –º–≥';
            document.getElementById('lvlAutobot').innerText = GameState.autobotLevel;
            document.getElementById('costAutobot').innerText = getUpgradeCost('autobot').toLocaleString() + ' –º–≥';

            // Location Button Update
            const locBtn = document.getElementById('btnLocation');
            if (GameState.locationLevel >= 4) {
                document.getElementById('nextLocName').innerText = "–ú–ê–ö–° –£–†–û–í–ï–ù–¨";
                document.getElementById('costLocation').innerText = "---";
                locBtn.style.opacity = 0.5;
            } else {
                document.getElementById('nextLocName').innerText = LocationNames[GameState.locationLevel + 1];
                document.getElementById('costLocation').innerText = getUpgradeCost('location').toLocaleString() + ' –º–≥';
                locBtn.style.opacity = 1;
            }

            updateSpecialItemUI('unstableIsotope', 'costIsotope', 'statusIsotope');
            updateSpecialItemUI('blueCrystal', 'costCrystal', 'statusCrystal');
            updateSpecialItemUI('darkMatter', 'costDarkMatter', 'statusDarkMatter');

            // Location Text & Background
            const currentName = LocationNames[GameState.locationLevel] || "Unknown";
            document.getElementById('levelDisplay').innerText = currentName;
            
            if (GameState.locationLevel !== currentBgLevel) {
                const body = document.getElementById('gameBody');
                if(currentBgLevel >= 0) body.classList.remove(`bg-lvl-${currentBgLevel}`);
                body.classList.add(`bg-lvl-${GameState.locationLevel}`);
                currentBgLevel = GameState.locationLevel;
            }
        }

        function updateSpecialItemUI(key, costId, statusId) {
            const btn = document.getElementById(costId).parentElement.parentElement;
            if (GameState.items[key]) {
                document.getElementById(costId).style.display = 'none';
                document.getElementById(statusId).style.display = 'block';
                document.getElementById(statusId).classList.remove('hidden');
                btn.style.opacity = '0.5';
                btn.style.borderColor = '#22c55e';
            } else {
                document.getElementById(costId).style.display = 'block';
                document.getElementById(statusId).style.display = 'none';
            }
        }

        setInterval(() => {
            if (GameState.energy < GameState.maxEnergy) {
                GameState.energy += GameState.energyRechargeRate;
                if (GameState.energy > GameState.maxEnergy) GameState.energy = GameState.maxEnergy;
            }
            if (GameState.autobotLevel > 0) {
                const earnings = GameState.autobotLevel * Upgrades.autobot.powerBase * GameState.multiplier;
                GameState.balance += earnings;
            }
            updateUI();
            if (Date.now() - GameState.lastSaveTime > 5000) saveGame();
        }, 1000);

        initTelegram();
        loadGame();

    </script>
</body>
</html>
