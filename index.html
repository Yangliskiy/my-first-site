<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Lab</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #050505;
            color: #ffffff;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Flask Pulse Animation */
        @keyframes liquid-pulse {
            0%, 100% { filter: drop-shadow(0 0 15px #22c55e); transform: scale(1); }
            50% { filter: drop-shadow(0 0 30px #4ade80); transform: scale(1.02); }
        }

        .flask-btn {
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: liquid-pulse 3s infinite;
        }

        .flask-btn:active {
            transform: scale(0.90) rotate(5deg);
        }

        /* Floating Number Animation */
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-120px) scale(1.5) rotate(10deg); }
        }

        .floating-text {
            position: absolute;
            color: #4ade80; /* Toxic Green */
            font-weight: 900;
            font-size: 28px;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            text-shadow: 0 0 10px #22c55e;
            z-index: 50;
            font-family: monospace;
        }

        /* Glassmorphism UI */
        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(74, 222, 128, 0.2);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Shop Modal Transition */
        .modal-enter { transform: translateY(100%); }
        .modal-active { transform: translateY(0); }
    </style>
</head>
<body class="h-screen w-full flex flex-col justify-between items-center p-4 bg-[url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center">
    
    <!-- Dark overlay with green tint -->
    <div class="absolute inset-0 bg-black/90 z-0"></div>
    <div class="absolute inset-0 bg-green-900/10 z-0 pointer-events-none mix-blend-overlay"></div>

    <!-- MAIN APP CONTENT -->
    <div class="relative z-10 w-full max-w-md flex flex-col h-full justify-between pb-4">
        
        <!-- Header: Stats -->
        <div class="w-full flex justify-between items-center glass-panel rounded-2xl p-4 mb-4 mt-2 border-l-4 border-green-500">
            <div class="flex flex-col">
                <span class="text-xs text-green-400 uppercase tracking-widest font-mono">–°–∫–ª–∞–¥ (–º–≥)</span>
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded bg-green-900/50 border border-green-500 flex items-center justify-center text-xs font-bold text-green-400">‚ò£</div>
                    <span id="scoreDisplay" class="text-3xl font-mono font-bold tracking-wider text-green-300 drop-shadow-lg">0</span>
                </div>
            </div>
            <div class="text-right">
                <span class="text-xs text-gray-400 uppercase tracking-widest font-mono">–°—Ç–∞—Ç—É—Å –õ–∞–±—ã</span>
                <div id="levelDisplay" class="text-green-400 font-bold tracking-wide">–ü–æ–¥–≤–∞–ª</div>
            </div>
        </div>

        <!-- Game Area: The Flask -->
        <div class="flex-grow flex items-center justify-center relative w-full perspective-container">
            <!-- Click Target -->
            <div id="clickTarget" class="flask-btn w-72 h-72 flex items-center justify-center cursor-pointer no-select relative group tap-highlight-transparent">
                
                <!-- SVG Flask -->
                <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-[0_0_25px_rgba(74,222,128,0.6)]">
                    <defs>
                        <linearGradient id="liquidGrad" x1="0%" y1="100%" x2="0%" y2="0%">
                            <stop offset="0%" style="stop-color:#14532d;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#4ade80;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- Glass Container -->
                    <path d="M75,20 L125,20 L125,70 L160,130 C170,145 170,180 145,180 L55,180 C30,180 30,145 40,130 L75,70 Z" 
                          fill="rgba(255,255,255,0.05)" stroke="#a3e635" stroke-width="4" stroke-linejoin="round"/>
                    
                    <!-- Liquid (This part 'fills' visually) -->
                    <path d="M80,80 L120,80 L148,130 C155,142 155,170 140,170 L60,170 C45,170 45,142 52,130 Z" 
                          fill="url(#liquidGrad)" class="opacity-90"/>
                    
                    <!-- Bubble details -->
                    <circle cx="100" cy="150" r="5" fill="#fff" opacity="0.4" />
                    <circle cx="90" cy="130" r="3" fill="#fff" opacity="0.3" />
                    <circle cx="110" cy="160" r="4" fill="#fff" opacity="0.5" />
                </svg>

            </div>
        </div>

        <!-- Energy Bar -->
        <div class="w-full mb-4 px-2">
            <div class="flex justify-between text-sm mb-1 font-bold text-green-300 font-mono">
                <span>‚ö° –†–µ–∞–∫—Ç–æ—Ä</span>
                <span id="energyText">1000 / 1000</span>
            </div>
            <div class="w-full h-4 bg-black rounded border border-green-900 overflow-hidden relative">
                <!-- Striped background for industrial feel -->
                <div class="absolute inset-0 opacity-20 bg-[repeating-linear-gradient(45deg,transparent,transparent_10px,#000_10px,#000_20px)] z-10"></div>
                <div id="energyBar" class="h-full bg-gradient-to-r from-green-900 via-green-600 to-green-400 transition-all duration-300 relative z-0" style="width: 100%"></div>
            </div>
        </div>

        <!-- Shop Open Button (NEW) -->
        <div class="w-full">
            <button onclick="toggleShop()" class="w-full group relative overflow-hidden bg-green-900/40 hover:bg-green-800/60 border border-green-500/50 rounded-xl p-4 transition-all active:scale-95">
                <div class="absolute inset-0 bg-green-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div class="flex items-center justify-center gap-3 text-green-300 font-bold text-lg font-mono uppercase tracking-widest">
                    <span class="text-2xl">üõí</span>
                    –ú–∞–≥–∞–∑–∏–Ω –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                </div>
            </button>
        </div>
    </div>

    <!-- SHOP MODAL (NEW) -->
    <div id="shopModal" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-xl transform translate-y-full transition-transform duration-300 flex flex-col">
        <!-- Shop Header -->
        <div class="p-4 border-b border-green-800 flex justify-between items-center bg-green-900/20">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üõí</span>
                <h2 class="text-xl font-bold text-green-400 font-mono tracking-wider">–ß–ï–†–ù–´–ô –†–´–ù–û–ö</h2>
            </div>
            <button onclick="toggleShop()" class="w-10 h-10 rounded-full bg-red-900/30 text-red-400 border border-red-900/50 flex items-center justify-center hover:bg-red-900/50 active:scale-95 transition">
                ‚úï
            </button>
        </div>

        <!-- Shop Content -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
             <!-- Current Balance in Shop -->
             <div class="text-center mb-6 glass-panel rounded-xl p-4">
                <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞</div>
                <div class="text-3xl font-mono font-bold text-green-300 drop-shadow-lg"><span id="shopBalance">0</span> –º–≥</div>
             </div>

             <div class="text-xs text-gray-500 uppercase tracking-widest pl-2 mb-2">–£–ª—É—á—à–µ–Ω–∏—è</div>

             <!-- Upgrade Multitap -->
            <button onclick="buyUpgrade('multitap')" class="w-full group relative overflow-hidden bg-gray-900/80 border border-green-800 rounded-xl p-4 text-left transition-all active:bg-green-900/20 flex justify-between items-center shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-lg bg-green-900/30 flex items-center justify-center text-3xl border border-green-700/30 shadow-[0_0_15px_rgba(34,197,94,0.2)]">‚öóÔ∏è</div>
                    <div>
                        <div class="text-sm text-green-400 uppercase font-bold tracking-wide">–£–ª—É—á—à–∏—Ç—å –§–æ—Ä–º—É–ª—É</div>
                        <div class="text-xs text-gray-500 font-mono mt-1">–ë–æ–ª—å—à–µ –º–≥ –∑–∞ –∫–ª–∏–∫</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-mono text-white text-lg font-bold">–£—Ä. <span id="shopLvlMultitap">1</span></div>
                    <div class="text-green-500 text-sm font-mono mt-1" id="shopCostMultitap">100 –º–≥</div>
                </div>
            </button>

            <!-- Upgrade Energy -->
            <button onclick="buyUpgrade('energy')" class="w-full group relative overflow-hidden bg-gray-900/80 border border-purple-900/50 rounded-xl p-4 text-left transition-all active:bg-purple-900/20 flex justify-between items-center shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-lg bg-purple-900/30 flex items-center justify-center text-3xl border border-purple-700/30 shadow-[0_0_15px_rgba(168,85,247,0.2)]">üîã</div>
                    <div>
                        <div class="text-sm text-purple-400 uppercase font-bold tracking-wide">–ù–æ–≤—ã–π –†–µ–∞–∫—Ç–æ—Ä</div>
                        <div class="text-xs text-gray-500 font-mono mt-1">–ë–æ–ª—å—à–µ –µ–º–∫–æ—Å—Ç–∏</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-mono text-white text-lg font-bold">–£—Ä. <span id="shopLvlEnergy">1</span></div>
                    <div class="text-purple-500 text-sm font-mono mt-1" id="shopCostEnergy">100 –º–≥</div>
                </div>
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-10 left-1/2 transform -translate-x-1/2 bg-red-900/90 border border-red-500 text-red-100 px-6 py-3 rounded shadow-[0_0_20px_rgba(239,68,68,0.5)] opacity-0 transition-opacity duration-300 z-[60] pointer-events-none text-sm font-bold font-mono tracking-wide uppercase">
        –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—ã—Ä—å—è!
    </div>

    <script>
        // --- Game Config & State ---
        const GameState = {
            balance: 0,
            energy: 1000,
            maxEnergy: 1000,
            energyRechargeRate: 3, 
            multitapLevel: 1,
            energyLevel: 1,
            lastSaveTime: Date.now()
        };

        const Upgrades = {
            multitap: { baseCost: 100, costMultiplier: 2.2, powerBase: 1 },
            energy: { baseCost: 100, costMultiplier: 1.5, powerBase: 500 }
        };

        // --- Telegram Integration ---
        const tg = window.Telegram.WebApp;
        
        function initTelegram() {
            tg.expand();
            tg.ready();
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#000000');
        }

        // --- Core Logic ---

        function loadGame() {
            const saved = localStorage.getItem('neonLabSave_v2'); // Increment version
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(GameState, parsed);
                
                const now = Date.now();
                const secondsPassed = (now - GameState.lastSaveTime) / 1000;
                const regained = Math.floor(secondsPassed * GameState.energyRechargeRate);
                GameState.energy = Math.min(GameState.maxEnergy, GameState.energy + regained);
            }
            updateUI();
        }

        function saveGame() {
            GameState.lastSaveTime = Date.now();
            localStorage.setItem('neonLabSave_v2', JSON.stringify(GameState));
        }

        function getClickPower() {
            return GameState.multitapLevel; 
        }

        function getUpgradeCost(type) {
            const level = type === 'multitap' ? GameState.multitapLevel : GameState.energyLevel;
            const config = Upgrades[type];
            return Math.floor(config.baseCost * Math.pow(config.costMultiplier, level - 1));
        }

        // --- Interaction ---

        const clickTarget = document.getElementById('clickTarget');

        clickTarget.addEventListener('pointerdown', (e) => {
            e.preventDefault();

            // Allow multiple touches if energy permits
            if (GameState.energy >= getClickPower()) {
                handleTap(e);
            } else {
                // Shake animation
                clickTarget.style.transform = "translateX(5px) rotate(5deg)";
                setTimeout(() => clickTarget.style.transform = "translateX(-5px) rotate(-5deg)", 50);
                setTimeout(() => clickTarget.style.transform = "none", 100);
                tg.HapticFeedback.notificationOccurred('error');
            }
        });

        function handleTap(e) {
            const power = getClickPower();
            
            GameState.balance += power;
            GameState.energy -= power;
            
            // Haptics
            tg.HapticFeedback.impactOccurred('heavy'); 

            // Visual Tilt
            const rect = clickTarget.getBoundingClientRect();
            const x = e.clientX - rect.left - rect.width / 2;
            const y = e.clientY - rect.top - rect.height / 2;
            
            clickTarget.style.transform = `scale(0.95) rotate(${x/10}deg)`;
            setTimeout(() => {
                clickTarget.style.transform = 'scale(1) rotate(0deg)';
            }, 100);

            // Floating Text
            createFloatingText(e.clientX, e.clientY, `+${power} mg`);

            updateUI();
        }

        function createFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = text;
            const randomX = (Math.random() - 0.5) * 40;
            el.style.left = `${x + randomX}px`;
            el.style.top = `${y}px`;
            document.body.appendChild(el);

            setTimeout(() => el.remove(), 800);
        }

        // --- Shop Logic ---
        
        function toggleShop() {
            const modal = document.getElementById('shopModal');
            if (modal.classList.contains('translate-y-full')) {
                // Open
                modal.classList.remove('translate-y-full');
                tg.BackButton.show();
                tg.BackButton.onClick(() => toggleShop()); // Telegram back button support
            } else {
                // Close
                modal.classList.add('translate-y-full');
                tg.BackButton.hide();
                tg.BackButton.offClick();
            }
            updateUI(); // Refresh numbers in shop
        }

        window.buyUpgrade = function(type) {
            const cost = getUpgradeCost(type);
            
            if (GameState.balance >= cost) {
                GameState.balance -= cost;
                
                if (type === 'multitap') {
                    GameState.multitapLevel++;
                } else if (type === 'energy') {
                    GameState.energyLevel++;
                    GameState.maxEnergy += Upgrades.energy.powerBase;
                    GameState.energy = GameState.maxEnergy;
                }
                
                tg.HapticFeedback.notificationOccurred('success');
                saveGame();
                updateUI();
            } else {
                showToast("–ù–ï –•–í–ê–¢–ê–ï–¢ –°–´–†–¨–Ø!");
                tg.HapticFeedback.notificationOccurred('warning');
            }
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        }

        // --- UI Updates ---

        function updateUI() {
            // Main Screen
            const balString = Math.floor(GameState.balance).toLocaleString();
            document.getElementById('scoreDisplay').innerText = balString;
            document.getElementById('shopBalance').innerText = balString; // Also update in shop
            
            const pct = (GameState.energy / GameState.maxEnergy) * 100;
            const energyBar = document.getElementById('energyBar');
            energyBar.style.width = `${pct}%`;
            
            if(pct < 20) {
                energyBar.classList.remove('from-green-900', 'via-green-600', 'to-green-400');
                energyBar.classList.add('bg-red-600');
            } else {
                energyBar.classList.add('from-green-900', 'via-green-600', 'to-green-400');
                energyBar.classList.remove('bg-red-600');
            }

            document.getElementById('energyText').innerText = `${Math.floor(GameState.energy)} / ${GameState.maxEnergy}`;

            // Shop UI Updates
            document.getElementById('shopLvlMultitap').innerText = GameState.multitapLevel;
            document.getElementById('shopCostMultitap').innerText = getUpgradeCost('multitap').toLocaleString() + ' mg';
            
            document.getElementById('shopLvlEnergy').innerText = GameState.energyLevel;
            document.getElementById('shopCostEnergy').innerText = getUpgradeCost('energy').toLocaleString() + ' mg';

            // Rank Names
            let lvlName = "–ü–æ–¥–≤–∞–ª";
            if(GameState.balance > 5000) lvlName = "–ì–∞—Ä–∞–∂–Ω–∞—è –õ–∞–±–∞";
            if(GameState.balance > 25000) lvlName = "–ü—Ä–æ–º–∑–æ–Ω–∞";
            if(GameState.balance > 100000) lvlName = "–°–∏–Ω–¥–∏–∫–∞—Ç";
            if(GameState.balance > 1000000) lvlName = "–•–∞–π–∑–µ–Ω–±–µ—Ä–≥";
            document.getElementById('levelDisplay').innerText = lvlName;
        }

        // --- Loop ---

        setInterval(() => {
            if (GameState.energy < GameState.maxEnergy) {
                GameState.energy += GameState.energyRechargeRate;
                if (GameState.energy > GameState.maxEnergy) GameState.energy = GameState.maxEnergy;
                updateUI();
            }
            if (Date.now() - GameState.lastSaveTime > 5000) {
                saveGame();
            }
        }, 1000);

        initTelegram();
        loadGame();

    </script>
</body>
</html>
