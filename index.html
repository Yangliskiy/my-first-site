<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Lab</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Russo+One&family=Orbitron:wght@500;700;900&display=swap');

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #000;
            color: #ffffff;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* --- PHYSICS CANVAS --- */
        #physicsCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
        }

        /* --- LIQUID CANVAS --- */
        #liquidCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60; pointer-events: none;
        }

        /* --- FONTS & PULSE --- */
        body, button, span, div { text-shadow: 0 0 5px currentColor; }
        @keyframes text-breathe {
            0% { text-shadow: 0 0 4px currentColor; filter: brightness(1); }
            50% { text-shadow: 0 0 10px currentColor; filter: brightness(1.2); }
            100% { text-shadow: 0 0 4px currentColor; filter: brightness(1); }
        }
        h1, h2, .font-title, #scoreDisplay, #energyText { animation: text-breathe 3s infinite ease-in-out; }

        /* --- UI --- */
        .glass-panel {
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }
        .shop-grid { scrollbar-width: none; }
        .shop-grid::-webkit-scrollbar { display: none; }
        .tab-active {
            background: linear-gradient(to top, rgba(168,85,247,0.2), transparent);
            border-bottom: 2px solid #a855f7;
            color: #d8b4fe; text-shadow: 0 0 15px #a855f7;
        }
        .tab-inactive { color: #6b7280; border-bottom: 2px solid transparent; }
        button:active { transform: scale(0.97); }

        /* --- MAIN FLASK --- */
        .flask-main { transition: transform 0.05s; color: #22c55e; }
        .flask-main:active { transform: scale(0.95); }

        /* --- DRAG SYSTEM --- */
        .draggable-flask {
            position: relative; width: 60px; height: 90px;
            touch-action: none; z-index: 20;
            transition: transform 0.1s cubic-bezier(0.2, 0.8, 0.2, 1); transform-origin: center center;
        }
        .draggable-flask.dragging { z-index: 100; scale: 1.2; filter: drop-shadow(0 0 15px currentColor); transition: none; }
        .draggable-flask.pouring { transition: transform 0.3s ease; }
        .draggable-flask.pouring .flask-svg { transform: rotate(-100deg); }
        .flask-svg { width: 100%; height: 100%; transition: transform 0.3s ease; transform-origin: 50% 80%; }
        .flask-mouth { position: absolute; top: 2px; left: 25px; width: 10px; height: 10px; pointer-events: none; }
        .pour-stream {
            position: absolute; width: 6px; height: 0; top: 50px; left: 50%; transform: translateX(-50%);
            background: currentColor; border-radius: 4px; pointer-events: none; z-index: 40;
            transition: height 0.2s; box-shadow: 0 0 10px currentColor; opacity: 0.9;
        }
        #mixingPot { transition: transform 0.2s; }
        #mixingPot.receive-liquid { transform: scale(1.05); filter: drop-shadow(0 0 25px white); }
        #mixLiquid { transition: fill 0.5s ease; }

        /* --- CASINO ROULETTE --- */
        .roulette-wheel {
            width: 240px; height: 240px; border-radius: 50%; border: 8px solid #222;
            background: conic-gradient(#ef4444 0deg 60deg, #f59e0b 60deg 120deg, #22c55e 120deg 180deg, #3b82f6 180deg 240deg, #a855f7 240deg 300deg, #ec4899 300deg 360deg);
            position: relative; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            box-shadow: 0 0 40px rgba(0,0,0,0.8); color: white; font-weight: bold; font-size: 14px;
        }
        .roulette-label { position: absolute; top: 50%; left: 50%; transform-origin: 0 0; height: 110px; width: 0; display: flex; justify-content: center; padding-top: 10px; }
        .label-0 { transform: rotate(30deg) translateY(-110px); }
        .label-1 { transform: rotate(90deg) translateY(-110px); }
        .label-2 { transform: rotate(150deg) translateY(-110px); }
        .label-3 { transform: rotate(210deg) translateY(-110px); }
        .label-4 { transform: rotate(270deg) translateY(-110px); }
        .label-5 { transform: rotate(330deg) translateY(-110px); }
        .roulette-pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #fbbf24;
            z-index: 20; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.8));
        }
        .spin-ready { background: #eab308; color: black; box-shadow: 0 0 20px #eab308; animation: pulse-gold 1s infinite; }
        @keyframes pulse-gold { 0%, 100% { box-shadow: 0 0 10px #eab308; } 50% { box-shadow: 0 0 30px #eab308; } }
        .spin-cooldown { background: #333; color: #777; cursor: not-allowed; }

        /* --- CASE OPENING (CS:GO STYLE) --- */
        #caseModal {
            z-index: 150;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
        }
        .case-window {
            width: 100%;
            height: 140px;
            background: #111;
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 30px #000;
        }
        .case-reel {
            display: flex;
            height: 100%;
            align-items: center;
            /* Will be animated via transform */
            width: max-content; 
        }
        .case-item {
            width: 100px;
            height: 100px;
            margin: 0 5px;
            background: #1a1a1a;
            border-bottom: 4px solid #555;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-family: 'Russo One', sans-serif;
            position: relative;
        }
        .case-item.rarity-common { border-color: #9ca3af; background: linear-gradient(to bottom, #1f2937, #111); }
        .case-item.rarity-uncommon { border-color: #22c55e; background: linear-gradient(to bottom, #064e3b, #111); }
        .case-item.rarity-rare { border-color: #3b82f6; background: linear-gradient(to bottom, #1e3a8a, #111); }
        .case-item.rarity-epic { border-color: #a855f7; background: linear-gradient(to bottom, #581c87, #111); box-shadow: 0 0 15px rgba(168,85,247,0.2); }
        .case-item.rarity-legendary { border-color: #eab308; background: linear-gradient(to bottom, #713f12, #111); box-shadow: 0 0 25px rgba(234,179,8,0.4); }
        
        .case-center-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #fbbf24;
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 10px #fbbf24;
        }

        /* --- SMUGGLER --- */
        #smugglerBtn { position: absolute; top: 70px; right: 10px; z-index: 60; animation: pulse-smuggler 2s infinite; }
        @keyframes pulse-smuggler { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .legendary-item { animation: legendary-shine 1.5s infinite alternate; background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01)); border: 1px solid transparent; }
        @keyframes legendary-shine { 0% { border-color: rgba(251,191,36,0.5); } 100% { border-color: rgba(236,72,153,0.8); box-shadow: 0 0 15px rgba(236,72,153,0.4); } }
    </style>
</head>
<body id="gameBody">
    
    <canvas id="physicsCanvas"></canvas>
    <canvas id="liquidCanvas"></canvas>

    <div id="smugglerBtn" class="hidden cursor-pointer" onclick="openSmuggler()">
        <div class="w-16 h-16 rounded-full bg-black border-2 border-purple-500 flex items-center justify-center text-4xl shadow-2xl relative">
            <span class="relative z-10">üïµÔ∏è‚Äç‚ôÇÔ∏è</span>
            <div class="absolute bottom-0 right-0 bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-tl-lg z-20" id="smugglerTimerDisplay">30s</div>
        </div>
    </div>

    <!-- MAIN UI -->
    <div class="relative z-10 w-full h-full flex flex-col justify-between p-4 max-w-md mx-auto">
        <!-- Header -->
        <div class="w-full flex justify-between items-center glass-panel rounded-2xl p-4 mb-2 border-l-4 border-purple-500">
            <div class="flex flex-col">
                <span class="text-[10px] text-purple-300 uppercase tracking-widest font-bold">–°–∫–ª–∞–¥ (–º–≥)</span>
                <div class="flex items-center gap-3">
                    <div id="secretAdminBtn" class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center text-sm cursor-pointer select-none">‚ò£</div>
                    <span id="scoreDisplay" class="text-3xl font-bold tracking-wider text-white">0</span>
                </div>
                <div class="text-xs text-purple-400 font-mono mt-1" id="passiveDisplay">0 –º–≥/—Å–µ–∫</div>
            </div>
            <div class="text-right">
                <span class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">–õ–æ–∫–∞—Ü–∏—è</span>
                <div id="levelDisplay" class="text-white font-bold text-lg tracking-wide">–ü–æ–¥–≤–∞–ª</div>
                <div id="multiplierDisplay" class="text-[10px] text-yellow-400 font-bold mt-1">x1</div>
                <div id="boostTimer" class="text-[10px] text-red-400 font-bold mt-1 hidden">–ë–£–°–¢: 30s</div>
            </div>
        </div>

        <!-- CLICK AREA -->
        <div id="clickerArea" class="flex-grow flex items-center justify-center relative min-h-0">
            <div id="clickTarget" class="flask-main w-64 h-64 flex items-center justify-center cursor-pointer select-none relative z-10">
                <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-[0_0_30px_currentColor] overflow-visible">
                    <defs>
                        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                            <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                        </filter>
                    </defs>
                    <path d="M75,20 L125,20 L125,70 L160,130 C170,145 170,180 145,180 L55,180 C30,180 30,145 40,130 L75,70 Z" fill="rgba(255,255,255,0.05)" stroke="currentColor" stroke-width="4" stroke-linejoin="round"/>
                    <g filter="url(#glow)">
                        <path d="M80,80 L120,80 L148,130 C155,142 155,170 140,170 L60,170 C45,170 45,142 52,130 Z" fill="currentColor" class="opacity-80"/>
                        <circle cx="90" cy="160" r="4" fill="#fff" opacity="0.6"><animate attributeName="cy" values="160;100" dur="1.2s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.6;0" dur="1.2s" repeatCount="indefinite"/></circle>
                        <circle cx="110" cy="160" r="3" fill="#fff" opacity="0.6"><animate attributeName="cy" values="160;90" dur="1.5s" begin="0.3s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.6;0" dur="1.5s" begin="0.3s" repeatCount="indefinite"/></circle>
                        <circle cx="100" cy="170" r="5" fill="#fff" opacity="0.5"><animate attributeName="cy" values="170;110" dur="2s" begin="0.7s" repeatCount="indefinite"/><animate attributeName="r" values="5;8" dur="2s" begin="0.7s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.5;0" dur="2s" begin="0.7s" repeatCount="indefinite"/></circle>
                        <ellipse cx="100" cy="80" rx="20" ry="2" fill="rgba(255,255,255,0.4)"><animate attributeName="rx" values="20;22;20" dur="1s" repeatCount="indefinite"/><animate attributeName="ry" values="2;3;2" dur="1.5s" repeatCount="indefinite"/></ellipse>
                    </g>
                </svg>
            </div>
        </div>

        <!-- Energy -->
        <div class="w-full mb-3">
            <div class="flex justify-between text-xs mb-1 font-bold text-purple-200 tracking-wider"><span>‚ö° –≠–ù–ï–†–ì–ò–Ø</span><span id="energyText">1000/1000</span></div>
            <div class="w-full h-3 bg-gray-900 rounded-full border border-white/20 overflow-hidden relative">
                <div id="energyBar" class="h-full bg-gradient-to-r from-purple-900 via-purple-500 to-white transition-all duration-300" style="width: 100%"></div>
            </div>
        </div>

        <!-- Panels -->
        <div class="glass-panel rounded-2xl flex flex-col h-[40vh] overflow-hidden relative z-30">
            <div class="flex border-b border-white/10 bg-black/30 overflow-x-auto shrink-0">
                <button onclick="switchTab('upgrades')" id="tabUpgrades" class="flex-1 py-3 px-2 text-xs font-bold uppercase tracking-widest tab-active">–¶–µ—Ö</button>
                <button onclick="switchTab('synthesis')" id="tabSynthesis" class="flex-1 py-3 px-2 text-xs font-bold uppercase tracking-widest tab-inactive">–°–∏–Ω—Ç–µ–∑</button>
                <button onclick="switchTab('casino')" id="tabCasino" class="flex-1 py-3 px-2 text-xs font-bold uppercase tracking-widest tab-inactive text-yellow-400">–£–¥–∞—á–∞</button>
                <button onclick="switchTab('blackmarket')" id="tabBlackmarket" class="flex-1 py-3 px-2 text-xs font-bold uppercase tracking-widest tab-inactive text-red-400">–ß.–†—ã–Ω–æ–∫</button>
            </div>

            <div class="flex-1 overflow-y-auto shop-grid p-3 relative h-full">
                <!-- Upgrades -->
                <div id="contentUpgrades" class="space-y-3">
                    <button onclick="buyUpgrade('location')" id="btnLocation" class="w-full group relative overflow-hidden bg-gradient-to-r from-indigo-900/60 to-purple-900/60 border border-indigo-500/40 rounded-xl p-3 text-left transition-all">
                        <div class="flex justify-between items-center relative z-10">
                            <div class="flex items-center gap-3"><div class="text-2xl">üèóÔ∏è</div><div><div class="text-xs text-indigo-200 uppercase font-bold">–ü–µ—Ä–µ–µ–∑–¥</div><div class="text-[10px] text-indigo-300">–î–æ—Ö–æ–¥ x2</div></div></div>
                            <div class="text-right"><div class="text-white text-sm font-bold" id="nextLocName">–ì–∞—Ä–∞–∂</div><div class="text-indigo-300 text-xs font-bold" id="costLocation">5,000</div></div>
                        </div>
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="buyUpgrade('multitap')" class="bg-white/5 border border-white/10 rounded-xl p-2 text-left h-20 flex flex-col justify-between hover:bg-white/10"><div class="text-[10px] text-purple-300 font-bold uppercase">–°–∏–Ω—Ç–µ–∑</div><div class="text-white font-bold">–£—Ä. <span id="lvlMultitap">1</span></div><div class="text-gray-400 text-[10px]" id="costMultitap">100</div></button>
                        <button onclick="buyUpgrade('energy')" class="bg-white/5 border border-white/10 rounded-xl p-2 text-left h-20 flex flex-col justify-between hover:bg-white/10"><div class="text-[10px] text-pink-300 font-bold uppercase">–ï–º–∫–æ—Å—Ç—å</div><div class="text-white font-bold">–£—Ä. <span id="lvlEnergy">1</span></div><div class="text-gray-400 text-[10px]" id="costEnergy">100</div></button>
                        <button onclick="buyUpgrade('recharge')" class="bg-white/5 border border-white/10 rounded-xl p-2 text-left h-20 flex flex-col justify-between hover:bg-white/10"><div class="text-[10px] text-blue-300 font-bold uppercase">–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ</div><div class="text-white font-bold">–£—Ä. <span id="lvlRecharge">1</span></div><div class="text-gray-400 text-[10px]" id="costRecharge">100</div></button>
                        <button onclick="buyUpgrade('autobot')" class="bg-white/5 border border-white/10 rounded-xl p-2 text-left h-20 flex flex-col justify-between hover:bg-white/10"><div class="text-[10px] text-yellow-300 font-bold uppercase">–ê–≤—Ç–æ-–í–∞—Ä–∫–∞</div><div class="text-white font-bold">–£—Ä. <span id="lvlAutobot">0</span></div><div class="text-gray-400 text-[10px]" id="costAutobot">500</div></button>
                    </div>
                </div>

                <!-- Synthesis -->
                <div id="contentSynthesis" class="hidden h-full flex flex-col items-center">
                    <div class="w-full bg-black/40 rounded-xl p-2 text-center border border-white/10 mb-2 shrink-0">
                        <div class="flex items-center justify-center gap-2">
                            <div id="targetColorSample" class="w-6 h-6 rounded-full border border-white/50 shadow-[0_0_15px_currentColor]"></div>
                            <span id="targetColorName" class="font-bold text-lg">–¶–ï–õ–¨</span>
                        </div>
                    </div>
                    <div class="flex-grow w-full flex flex-col items-center justify-center relative">
                        <div id="mixingPot" class="relative w-32 h-32 flex items-center justify-center transition-transform">
                            <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-[0_0_20px_rgba(255,255,255,0.2)] pointer-events-none">
                                <path d="M20,20 L80,20 L80,80 C80,90 70,95 50,95 C30,95 20,90 20,80 Z" fill="rgba(255,255,255,0.05)" stroke="white" stroke-width="1"/>
                                <path id="mixLiquid" d="M22,88 L78,88 L78,90 C78,92 68,93 50,93 C32,93 22,92 22,90 Z" fill="#111"/>
                            </svg>
                        </div>
                        <div class="w-full grid grid-cols-3 gap-2 px-2 h-28 items-end mt-4">
                            <!-- Flasks -->
                            <div class="flex flex-col items-center relative h-full justify-end">
                                <div class="draggable-flask cursor-grab text-red-500" data-color="red"><div class="flask-svg"><div class="flask-mouth"></div><svg viewBox="0 0 50 80" class="w-full h-full drop-shadow-[0_0_10px_currentColor] pointer-events-none"><path d="M15,2 L35,2 L35,20 L45,70 C48,78 40,78 25,78 C10,78 2,78 5,70 L15,20 Z" fill="rgba(255,0,0,0.1)" stroke="currentColor"/><path d="M16,20 L34,20 L44,70 C46,76 40,76 25,76 C10,76 4,76 6,70 Z" fill="currentColor"/></svg></div></div>
                            </div>
                            <div class="flex flex-col items-center relative h-full justify-end">
                                <div class="draggable-flask cursor-grab text-green-500" data-color="green"><div class="flask-svg"><div class="flask-mouth"></div><svg viewBox="0 0 50 80" class="w-full h-full drop-shadow-[0_0_10px_currentColor] pointer-events-none"><path d="M15,2 L35,2 L35,20 L45,70 C48,78 40,78 25,78 C10,78 2,78 5,70 L15,20 Z" fill="rgba(0,255,0,0.1)" stroke="currentColor"/><path d="M16,20 L34,20 L44,70 C46,76 40,76 25,76 C10,76 4,76 6,70 Z" fill="currentColor"/></svg></div></div>
                            </div>
                            <div class="flex flex-col items-center relative h-full justify-end">
                                <div class="draggable-flask cursor-grab text-blue-500" data-color="blue"><div class="flask-svg"><div class="flask-mouth"></div><svg viewBox="0 0 50 80" class="w-full h-full drop-shadow-[0_0_10px_currentColor] pointer-events-none"><path d="M15,2 L35,2 L35,20 L45,70 C48,78 40,78 25,78 C10,78 2,78 5,70 L15,20 Z" fill="rgba(0,0,255,0.1)" stroke="currentColor"/><path d="M16,20 L34,20 L44,70 C46,76 40,76 25,76 C10,76 4,76 6,70 Z" fill="currentColor"/></svg></div></div>
                            </div>
                        </div>
                    </div>
                    <button onclick="resetMix()" class="text-xs text-gray-400 underline mb-2 absolute top-2 right-4">–°–ë–†–û–°</button>
                    <div id="synthesisCooldown" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center text-center hidden backdrop-blur-md rounded-lg">
                        <div class="text-white font-bold text-lg">–û–•–õ–ê–ñ–î–ï–ù–ò–ï</div>
                        <div id="cooldownTimer" class="text-3xl font-mono text-purple-400 font-bold mt-2">00:00</div>
                    </div>
                </div>

                <!-- Casino -->
                <div id="contentCasino" class="hidden h-full flex flex-col items-center space-y-4 pt-2">
                    <div class="w-full bg-white/5 rounded-2xl p-4 border border-white/10 flex flex-col items-center shadow-lg">
                        <div class="text-xs text-yellow-400 uppercase font-bold tracking-widest mb-2">–°–ø–∏–Ω (–∫–∞–∂–¥—ã–µ 3—á)</div>
                        <div class="relative mb-4">
                            <div class="roulette-pointer"></div>
                            <div class="roulette-wheel" id="rouletteWheel">
                                <div class="roulette-label label-0"><span>500</span></div>
                                <div class="roulette-label label-1"><span>1K</span></div>
                                <div class="roulette-label label-2"><span>‚ö°</span></div>
                                <div class="roulette-label label-3"><span>5K</span></div>
                                <div class="roulette-label label-4"><span>10K</span></div>
                                <div class="roulette-label label-5"><span>50K</span></div>
                            </div>
                            <div class="roulette-center"></div>
                        </div>
                        <button id="btnSpin" onclick="spinRoulette()" class="spin-ready text-black font-bold py-3 px-10 rounded-full uppercase tracking-widest shadow-lg transition w-full">–ö–†–£–¢–ò–¢–¨</button>
                        <div id="spinTimer" class="text-xs text-gray-400 mt-2 hidden">–¢–∞–π–º–µ—Ä: <span id="spinTimeVal">00:00:00</span></div>
                    </div>
                    <div class="w-full grid grid-cols-2 gap-3">
                        <button onclick="openCase('basic')" class="bg-gray-800/80 border border-gray-600/50 p-3 rounded-xl flex flex-col items-center active:scale-95 transition">
                            <div class="text-4xl mb-2">üì¶</div>
                            <div class="text-xs text-gray-300 font-bold">–ë–ê–ó–û–í–´–ô</div>
                            <div class="text-green-400 text-xs font-mono font-bold">2,000</div>
                        </button>
                        <button onclick="openCase('neon')" class="bg-purple-900/30 border border-purple-500/50 p-3 rounded-xl flex flex-col items-center active:scale-95 transition">
                            <div class="text-4xl mb-2">üîí</div>
                            <div class="text-xs text-purple-300 font-bold">–ö–ò–ë–ï–†</div>
                            <div class="text-purple-400 text-xs font-mono font-bold">20,000</div>
                        </button>
                    </div>
                </div>

                <!-- Black Market -->
                <div id="contentBlackmarket" class="hidden space-y-3 pt-2">
                    <button onclick="buyItem('unstableIsotope')" id="btnIsotope" class="w-full bg-red-900/20 border border-red-500/30 rounded-xl p-3 text-left flex justify-between items-center transition hover:bg-red-900/30">
                        <div class="flex items-center gap-3"><div class="text-2xl">‚ò¢Ô∏è</div><div><div class="text-sm text-red-300 font-bold">–ò–∑–æ—Ç–æ–ø</div><div class="text-[10px] text-gray-400">–ö—Ä–∏—Ç x5</div></div></div>
                        <div class="text-right"><div class="text-red-400 font-mono font-bold text-sm" id="costIsotope">2,500</div><div id="statusIsotope" class="hidden text-xs text-green-500 border border-green-500 px-1 rounded">V</div></div>
                    </button>
                    <button onclick="buyItem('blueCrystal')" id="btnCrystal" class="w-full bg-cyan-900/20 border border-cyan-500/30 rounded-xl p-3 text-left flex justify-between items-center transition hover:bg-cyan-900/30">
                        <div class="flex items-center gap-3"><div class="text-2xl">üíé</div><div><div class="text-sm text-cyan-300 font-bold">–ö—Ä–∏—Å—Ç–∞–ª–ª</div><div class="text-[10px] text-gray-400">–î–æ—Ö–æ–¥ x2</div></div></div>
                        <div class="text-right"><div class="text-cyan-400 font-mono font-bold text-sm" id="costCrystal">10,000</div><div id="statusCrystal" class="hidden text-xs text-green-500 border border-green-500 px-1 rounded">V</div></div>
                    </button>
                    <button onclick="buyItem('darkMatter')" id="btnDarkMatter" class="w-full bg-fuchsia-900/20 border border-fuchsia-500/30 rounded-xl p-3 text-left flex justify-between items-center transition hover:bg-fuchsia-900/30">
                        <div class="flex items-center gap-3"><div class="text-2xl">üåå</div><div><div class="text-sm text-fuchsia-300 font-bold">–ú–∞—Ç–µ—Ä–∏—è</div><div class="text-[10px] text-gray-400">–î–æ—Ö–æ–¥ x5</div></div></div>
                        <div class="text-right"><div class="text-fuchsia-400 font-mono font-bold text-sm" id="costDarkMatter">100k</div><div id="statusDarkMatter" class="hidden text-xs text-green-500 border border-green-500 px-1 rounded">V</div></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Case Opening Modal -->
    <div id="caseModal" class="fixed inset-0 hidden flex flex-col justify-center items-center p-6 transition-opacity duration-300">
        <h2 class="text-2xl font-bold text-white mb-4 tracking-widest uppercase text-shadow-lg font-title">–û–¢–ö–†–´–¢–ò–ï</h2>
        <div class="case-window rounded-xl border-4 border-gray-700 bg-gray-900">
            <div class="case-center-line"></div>
            <div class="case-reel" id="caseReel">
                <!-- Items injected via JS -->
            </div>
        </div>
        <div class="mt-6 text-yellow-400 font-mono text-xl animate-pulse" id="caseStatus">–ö–†–£–¢–ò–ú...</div>
    </div>

    <!-- Smuggler Modal -->
    <div id="smugglerModal" class="fixed inset-0 z-[100] hidden flex flex-col justify-center items-center p-6 bg-black/90 backdrop-blur-xl">
        <div class="smuggler-modal w-full max-w-sm rounded-3xl p-6 relative overflow-hidden flex flex-col border border-purple-500/50 shadow-[0_0_50px_purple]">
            <button class="absolute top-3 right-3 text-white/50 text-2xl" onclick="closeSmuggler()">‚úï</button>
            <div class="text-center mb-4">
                <div class="text-6xl mb-2 animate-bounce">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
                <h2 class="text-xl font-bold text-white uppercase tracking-widest">–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∏—Å—Ç</h2>
                <div class="text-xs text-gray-400">–£—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑: <span id="smugglerModalTimer" class="text-red-500 font-mono font-bold">30s</span></div>
            </div>
            <div class="space-y-3">
                <button onclick="buyLegendary('hulkSerum')" class="w-full rounded-xl p-3 flex items-center gap-3 legendary-item active:scale-95 transition"><div class="text-3xl">üß™</div><div class="text-left flex-1"><div class="text-green-300 font-bold text-xs">–°—ã–≤–æ—Ä–æ—Ç–∫–∞ –•–∞–ª–∫–∞</div><div class="text-[10px] text-gray-400">–ö–ª–∏–∫ x50 (60s)</div></div><div class="text-yellow-400 font-bold text-sm">50k</div></button>
                <button onclick="buyLegendary('timeLoop')" class="w-full rounded-xl p-3 flex items-center gap-3 legendary-item active:scale-95 transition"><div class="text-3xl">‚è≥</div><div class="text-left flex-1"><div class="text-blue-300 font-bold text-xs">–ü–µ—Ç–ª—è –í—Ä–µ–º–µ–Ω–∏</div><div class="text-[10px] text-gray-400">+4 —á–∞—Å–∞</div></div><div class="text-yellow-400 font-bold text-sm">100k</div></button>
                <button onclick="buyLegendary('unicornTear')" class="w-full rounded-xl p-3 flex items-center gap-3 legendary-item active:scale-95 transition"><div class="text-3xl">üíé</div><div class="text-left flex-1"><div class="text-pink-300 font-bold text-xs">–°–ª–µ–∑–∞ –ï–¥–∏–Ω–æ—Ä–æ–≥–∞</div><div class="text-[10px] text-gray-400">–í–µ—á–Ω—ã–π x5</div></div><div class="text-yellow-400 font-bold text-sm">1M</div></button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-black/80 border border-purple-500 text-white px-6 py-3 rounded-xl opacity-0 pointer-events-none text-sm font-bold font-mono uppercase transition-all z-[200]">Msg</div>

    <script>
        /* --- PHYSICS BACKGROUND --- */
        const canvas = document.getElementById('physicsCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let tiltX = 0, tiltY = 0;
        let currentGlobalHue = 120; // Green

        // --- GAME STATE ---
        const GameState = {
            balance: 0, energy: 1000, maxEnergy: 1000, energyRechargeRate: 3,
            multitapLevel: 1, energyLevel: 1, rechargeLevel: 1, autobotLevel: 0, locationLevel: 0,
            multiplier: 1, permMultiplier: 1,
            items: { unstableIsotope: false, blueCrystal: false, darkMatter: false },
            boostEndTime: 0, hulkEndTime: 0,
            synthesisCooldown: 0, lastSpinTime: 0,
            smuggler: { active: false, departTime: 0, nextArrival: Date.now() + 60000 },
            lastSaveTime: Date.now()
        };

        const LevelThemes = [120, 210, 30, 180, 270];

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        class Particle {
            constructor() {
                this.x = Math.random() * width; this.y = Math.random() * height;
                this.size = Math.random() * 2 + 1;
                this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5;
                this.hueOffset = Math.random() * 40 - 20; this.alpha = Math.random() * 0.5 + 0.2;
            }
            update() {
                this.vx += tiltX * 0.05; this.vy += tiltY * 0.05;
                this.vx *= 0.98; this.vy *= 0.98;
                this.x += this.vx; this.y += this.vy;
                if(this.x < 0) this.x = width; if(this.x > width) this.x = 0;
                if(this.y < 0) this.y = height; if(this.y > height) this.y = 0;
            }
            draw() {
                const h = currentGlobalHue + this.hueOffset;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `hsl(${h}, 70%, 60%)`; ctx.globalAlpha = this.alpha;
                ctx.fill(); ctx.globalAlpha = 1; ctx.shadowBlur = 10; ctx.shadowColor = `hsl(${h}, 70%, 60%)`;
            }
        }
        for(let i=0; i<80; i++) particles.push(new Particle());

        function animateBg() {
            ctx.clearRect(0, 0, width, height);
            let target = LevelThemes[GameState.locationLevel] || 120;
            if (Math.abs(currentGlobalHue - target) > 0.5) currentGlobalHue += (target - currentGlobalHue) * 0.05;
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateBg);
        }
        animateBg();

        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', (e) => {
                tiltX = (e.gamma) / 45; tiltY = (e.beta) / 45;
                if(tiltX>1)tiltX=1; if(tiltX<-1)tiltX=-1; if(tiltY>1)tiltY=1; if(tiltY<-1)tiltY=-1;
            });
        }
        document.addEventListener('mousemove', (e) => {
            tiltX = (e.clientX / width - 0.5) * 2; tiltY = (e.clientY / height - 0.5) * 2;
        });

        // --- LIQUID PHYSICS ---
        const liquidCanvas = document.getElementById('liquidCanvas');
        const lCtx = liquidCanvas.getContext('2d');
        let lWidth, lHeight;
        let liquidParticles = []; // {x, y, vx, vy, color, life}
        let splashParticles = [];

        function resizeLiquid() { lWidth = liquidCanvas.width = window.innerWidth; lHeight = liquidCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeLiquid); resizeLiquid();

        function spawnPourParticles(x, y, color) {
            for(let i=0; i<3; i++) {
                liquidParticles.push({
                    x: x + (Math.random()-0.5)*4, 
                    y: y + (Math.random()-0.5)*4,
                    vx: (Math.random()-0.5)*1,
                    vy: Math.random()*2 + 2, 
                    color: color,
                    life: 1.0
                });
            }
        }

        function spawnSplash(x, y, color) {
            for(let i=0; i<5; i++) {
                splashParticles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*4,
                    vy: (Math.random()-1)*4, 
                    color: color,
                    life: 1.0,
                    size: Math.random()*3 + 1
                });
            }
        }

        function animateLiquid() {
            lCtx.clearRect(0, 0, lWidth, lHeight);
            const mixingPot = document.getElementById('mixingPot');
            const potRect = mixingPot.getBoundingClientRect();
            const potY = potRect.top + potRect.height * 0.7; 

            for (let i = liquidParticles.length - 1; i >= 0; i--) {
                let p = liquidParticles[i];
                p.x += p.vx; p.y += p.vy; p.vy += 0.5; 
                lCtx.beginPath(); lCtx.moveTo(p.x, p.y); lCtx.lineTo(p.x - p.vx, p.y - p.vy*1.5);
                lCtx.strokeStyle = p.color === 'red' ? '#ef4444' : p.color === 'green' ? '#22c55e' : '#3b82f6';
                lCtx.lineWidth = 3; lCtx.lineCap = 'round'; lCtx.stroke();

                if (p.y >= potY && p.x >= potRect.left && p.x <= potRect.right) {
                    spawnSplash(p.x, potY, p.color); liquidParticles.splice(i, 1);
                } else if (p.y > lHeight) { liquidParticles.splice(i, 1); }
            }

            for (let i = splashParticles.length - 1; i >= 0; i--) {
                let s = splashParticles[i];
                s.x += s.vx; s.y += s.vy; s.vy += 0.2; s.life -= 0.05;
                if (s.life <= 0) { splashParticles.splice(i, 1); continue; }
                lCtx.beginPath(); lCtx.arc(s.x, s.y, s.size, 0, Math.PI*2);
                lCtx.fillStyle = s.color === 'red' ? '#ef4444' : s.color === 'green' ? '#22c55e' : '#3b82f6';
                lCtx.globalAlpha = s.life; lCtx.fill(); lCtx.globalAlpha = 1;
            }
            requestAnimationFrame(animateLiquid);
        }
        animateLiquid();


        // --- REST OF CONFIG ---
        const LocationNames = ["–ü–æ–¥–≤–∞–ª", "–ì–∞—Ä–∞–∂", "–ó–∞–≤–æ–¥", "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", "–ö–æ—Å–º–æ—Å"];
        const Upgrades = {
            multitap: { baseCost: 100, costMultiplier: 2.0, powerBase: 1 },
            energy: { baseCost: 100, costMultiplier: 1.5, powerBase: 500 },
            recharge: { baseCost: 300, costMultiplier: 1.8, powerBase: 1 },
            autobot: { baseCost: 500, costMultiplier: 2.5, powerBase: 1 },
            location: { baseCost: 5000, costMultiplier: 5.0, powerBase: 1 }
        };
        const SpecialItems = { unstableIsotope: { cost: 2500 }, blueCrystal: { cost: 10000 }, darkMatter: { cost: 100000 } };
        const MixRecipes = { "purple": ["red", "blue"], "yellow": ["red", "green"], "cyan": ["green", "blue"], "white": ["red", "green", "blue"] };
        const ColorNames = { "purple": {name: "–§–ò–û–õ–ï–¢–û–í–´–ô", hex: "#a855f7"}, "yellow": {name: "–ñ–ï–õ–¢–´–ô", hex: "#eab308"}, "cyan": {name: "–ë–ò–†–Æ–ó–û–í–´–ô", hex: "#06b6d4"}, "white": {name: "–ë–ï–õ–´–ô", hex: "#ffffff"} };
        
        let currentMix = []; let targetMix = "";
        const tg = window.Telegram.WebApp;

        function initTelegram() { tg.expand(); tg.ready(); tg.setHeaderColor('#000000'); tg.setBackgroundColor('#000000'); }
        function loadGame() {
            const saved = localStorage.getItem('neonLabSave_v23'); 
            if (saved) { Object.assign(GameState, JSON.parse(saved)); } 
            else { GameState.lastSpinTime = 0; } 
            recalcMultiplier(); initSynthesis(); initDraggableFlasks(); updateUI();
        }
        function saveGame() { GameState.lastSaveTime = Date.now(); localStorage.setItem('neonLabSave_v23', JSON.stringify(GameState)); }
        function recalcMultiplier() {
            let mult = 1;
            if(GameState.items.blueCrystal) mult *= 2; if(GameState.items.darkMatter) mult *= 5;
            mult *= GameState.permMultiplier;
            if(GameState.locationLevel > 0) mult *= Math.pow(2, GameState.locationLevel);
            if(Date.now() < GameState.boostEndTime) mult *= 10;
            if(Date.now() < GameState.hulkEndTime) mult *= 50;
            GameState.multiplier = mult;
        }

        // --- SYNTHESIS LOGIC ---
        function initSynthesis() {
            const keys = Object.keys(MixRecipes); targetMix = keys[Math.floor(Math.random() * keys.length)];
            const info = ColorNames[targetMix];
            document.getElementById('targetColorName').innerText = info.name;
            document.getElementById('targetColorName').style.color = info.hex;
            document.getElementById('targetColorSample').style.backgroundColor = info.hex;
            document.getElementById('targetColorSample').style.boxShadow = `0 0 20px ${info.hex}`;
            currentMix = []; updateMixVisuals();
        }

        function initDraggableFlasks() {
            const flasks = document.querySelectorAll('.draggable-flask');
            const mixingPot = document.getElementById('mixingPot');
            
            flasks.forEach(flask => {
                let startX, startY;
                let isDragging = false;
                let pourInterval;

                const onStart = (e) => {
                    if(Date.now() < GameState.synthesisCooldown || flask.classList.contains('pouring')) return;
                    e.preventDefault();
                    isDragging = true;
                    flask.classList.add('dragging');
                    const t = e.touches ? e.touches[0] : e;
                    startX = t.clientX; startY = t.clientY;
                };

                const onMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const t = e.touches ? e.touches[0] : e;
                    const dx = t.clientX - startX;
                    const dy = t.clientY - startY;
                    flask.style.transform = `translate(${dx}px, ${dy}px) scale(1.2)`;

                    const rect1 = flask.getBoundingClientRect();
                    const rect2 = mixingPot.getBoundingClientRect();
                    if(isOverlapping(rect1, rect2)) {
                        mixingPot.classList.add('receive-liquid');
                        
                        if(!flask.classList.contains('pouring')) {
                            const color = flask.dataset.color;
                            if(currentMix.length < 3 && !currentMix.includes(color)) {
                                flask.classList.add('pouring'); 
                                tg.HapticFeedback.impactOccurred('medium');
                                
                                let pouredAmount = 0;
                                pourInterval = setInterval(() => {
                                    const mouthRect = flask.querySelector('.flask-mouth').getBoundingClientRect();
                                    spawnPourParticles(mouthRect.left, mouthRect.top, color);
                                    
                                    pouredAmount++;
                                    if(pouredAmount > 30) {
                                        clearInterval(pourInterval);
                                        currentMix.push(color);
                                        updateMixVisuals();
                                        checkWin();
                                    }
                                }, 16); 
                            }
                        }
                    } else {
                        mixingPot.classList.remove('receive-liquid');
                    }
                };

                const onEnd = () => {
                    isDragging = false;
                    flask.classList.remove('dragging');
                    flask.classList.remove('pouring');
                    flask.style.transform = ''; 
                    mixingPot.classList.remove('receive-liquid');
                    clearInterval(pourInterval);
                };

                flask.addEventListener('touchstart', onStart);
                window.addEventListener('touchmove', onMove, {passive: false});
                window.addEventListener('touchend', onEnd);
                flask.addEventListener('mousedown', onStart);
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onEnd);
            });
        }

        function checkWin() {
            const recipe = MixRecipes[targetMix];
            const s1 = [...currentMix].sort().join(','), s2 = [...recipe].sort().join(',');
            if(s1===s2) {
                GameState.boostEndTime = Date.now()+30000; GameState.synthesisCooldown = Date.now()+300000;
                recalcMultiplier(); switchTab('upgrades'); showToast("–°–ò–ù–¢–ï–ó –£–°–ü–ï–®–ï–ù!"); initSynthesis();
            } else if(currentMix.length >= recipe.length) {
                showToast("–ù–ï–°–¢–ê–ë–ò–õ–¨–ù–û!"); setTimeout(resetMix, 500);
            }
        }

        function isOverlapping(r1, r2) {
            return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
        }

        function updateMixVisuals() {
            const liquid = document.getElementById('mixLiquid');
            if(currentMix.length===0) {
                liquid.style.fill="#111";
                liquid.setAttribute('d', "M22,88 L78,88 L78,90 C78,92 68,93 50,93 C32,93 22,92 22,90 Z");
            } else {
                const map = {red:[255,0,0], green:[0,255,0], blue:[0,0,255]};
                let r=0,g=0,b=0;
                currentMix.forEach(c=>{ r+=map[c][0]; g+=map[c][1]; b+=map[c][2]; });
                r/=currentMix.length; g/=currentMix.length; b/=currentMix.length;
                liquid.style.fill = `rgb(${r},${g},${b})`;
                const level = 88 - (currentMix.length * 15);
                liquid.setAttribute('d', `M22,${level} L78,${level} L78,80 C78,88 68,93 50,93 C32,93 22,88 22,80 Z`);
            }
        }
        function resetMix() { currentMix=[]; updateMixVisuals(); }

        // --- CORE FUNCTIONS ---
        function updateUI() {
            document.getElementById('scoreDisplay').innerText = Math.floor(GameState.balance).toLocaleString();
            document.getElementById('energyText').innerText = Math.floor(GameState.energy) + "/" + GameState.maxEnergy;
            document.getElementById('energyBar').style.width = (GameState.energy/GameState.maxEnergy*100) + "%";
            
            const isHulk = Date.now() < GameState.hulkEndTime;
            const isBoost = Date.now() < GameState.boostEndTime;
            document.getElementById('multiplierDisplay').innerText = "x" + GameState.multiplier + (isHulk?" üî•":isBoost?" ‚ö°":"");
            document.getElementById('multiplierDisplay').style.opacity = GameState.multiplier > 1 ? 1 : 0;

            const boostTimer = document.getElementById('boostTimer');
            if(isHulk) { boostTimer.classList.remove('hidden'); boostTimer.innerText = "–•–ê–õ–ö: " + Math.ceil((GameState.hulkEndTime - Date.now())/1000) + "s"; }
            else if(isBoost) { boostTimer.classList.remove('hidden'); boostTimer.innerText = "–ë–£–°–¢: " + Math.ceil((GameState.boostEndTime - Date.now())/1000) + "s"; }
            else { boostTimer.classList.add('hidden'); }

            const diff = Date.now() - GameState.lastSpinTime;
            const spinBtn = document.getElementById('btnSpin');
            const spinTimer = document.getElementById('spinTimer');
            const COOLDOWN_MS = 10800000;
            
            if(diff >= COOLDOWN_MS) {
                spinBtn.disabled = false; spinBtn.classList.remove('spin-cooldown'); spinBtn.classList.add('spin-ready'); spinBtn.innerText = "–ö–†–£–¢–ò–¢–¨"; spinTimer.classList.add('hidden');
            } else {
                spinBtn.disabled = true; spinBtn.classList.remove('spin-ready'); spinBtn.classList.add('spin-cooldown'); spinBtn.innerText = "–ñ–î–ê–¢–¨"; spinTimer.classList.remove('hidden');
                const left = COOLDOWN_MS - diff;
                const h = Math.floor(left/3600000), m = Math.floor((left%3600000)/60000), s = Math.floor((left%60000)/1000);
                document.getElementById('spinTimeVal').innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            }

            const cool = document.getElementById('synthesisCooldown');
            if(Date.now() < GameState.synthesisCooldown) {
                cool.classList.remove('hidden');
                const min = Math.floor((GameState.synthesisCooldown - Date.now())/60000);
                const sec = Math.floor(((GameState.synthesisCooldown - Date.now())%60000)/1000);
                document.getElementById('cooldownTimer').innerText = `${min}:${sec<10?'0'+sec:sec}`;
            } else { cool.classList.add('hidden'); }

            const getCost = (t, l) => Math.floor(Upgrades[t].baseCost * Math.pow(Upgrades[t].costMultiplier, l-1));
            document.getElementById('costMultitap').innerText = getCost('multitap', GameState.multitapLevel);
            document.getElementById('lvlMultitap').innerText = GameState.multitapLevel;
            document.getElementById('costEnergy').innerText = getCost('energy', GameState.energyLevel);
            document.getElementById('lvlEnergy').innerText = GameState.energyLevel;
            document.getElementById('costRecharge').innerText = getCost('recharge', GameState.rechargeLevel);
            document.getElementById('lvlRecharge').innerText = GameState.rechargeLevel;
            document.getElementById('costAutobot').innerText = getCost('autobot', GameState.autobotLevel+1);
            document.getElementById('lvlAutobot').innerText = GameState.autobotLevel;

            if(GameState.locationLevel >= 4) { document.getElementById('costLocation').innerText = "–ú–ê–ö–°"; document.getElementById('nextLocName').innerText = "–ö–û–°–ú–û–°"; }
            else { document.getElementById('costLocation').innerText = getCost('location', GameState.locationLevel+1); document.getElementById('nextLocName').innerText = LocationNames[GameState.locationLevel+1]; }
            document.getElementById('levelDisplay').innerText = LocationNames[GameState.locationLevel];

            ['Isotope','Crystal','DarkMatter'].forEach(id => {
                const key = id === 'Isotope' ? 'unstableIsotope' : id === 'Crystal' ? 'blueCrystal' : 'darkMatter';
                if(GameState.items[key]) {
                    document.getElementById('cost'+id).parentElement.style.display = 'none';
                    document.getElementById('status'+id).classList.remove('hidden');
                    document.getElementById('btn'+id).style.opacity = '0.5';
                }
            });
        }

        let ac=0, at;
        document.getElementById('secretAdminBtn').addEventListener('click', ()=>{
            ac++; clearTimeout(at); at=setTimeout(()=>{ac=0},1000);
            if(ac>=10) { GameState.balance+=1000000000; GameState.lastSpinTime=0; GameState.smuggler.nextArrival=Date.now(); saveGame(); updateUI(); showToast("ADMIN GOD MODE"); ac=0;}
        });

        function buyUpgrade(t) {
            if(t==='location' && GameState.locationLevel>=4) return;
            let lvl = (t==='multitap'?GameState.multitapLevel:t==='energy'?GameState.energyLevel:t==='recharge'?GameState.rechargeLevel:t==='autobot'?GameState.autobotLevel+1:GameState.locationLevel+1);
            let cost = Math.floor(Upgrades[t].baseCost * Math.pow(Upgrades[t].costMultiplier, lvl-1));
            if(GameState.balance>=cost) {
                GameState.balance-=cost;
                if(t==='multitap') GameState.multitapLevel++;
                if(t==='energy') { GameState.energyLevel++; GameState.maxEnergy+=500; GameState.energy=GameState.maxEnergy; }
                if(t==='recharge') GameState.rechargeLevel++;
                if(t==='autobot') GameState.autobotLevel++;
                if(t==='location') { GameState.locationLevel++; showToast("–ù–û–í–ê–Ø –õ–û–ö–ê–¶–ò–Ø!"); }
                recalcMultiplier(); saveGame(); updateUI();
            } else showToast("–ù–ï–¢ –î–ï–ù–ï–ì");
        }
        function buyItem(k) { if(GameState.items[k]) return; if(GameState.balance >= SpecialItems[k].cost) { GameState.balance -= SpecialItems[k].cost; GameState.items[k] = true; recalcMultiplier(); saveGame(); updateUI(); } }
        function buyLegendary(t) {
            let cost = (t==='hulkSerum')?50000:(t==='timeLoop')?100000:1000000;
            if(GameState.balance >= cost) {
                GameState.balance -= cost;
                if(t==='hulkSerum') GameState.hulkEndTime = Date.now()+60000; 
                if(t==='timeLoop') GameState.balance += Math.max(10000, (GameState.autobotLevel * Upgrades.autobot.powerBase * GameState.multiplier)*14400); 
                if(t==='unicornTear') GameState.permMultiplier *= 5; 
                recalcMultiplier(); closeSmuggler();
            } else showToast("–ù–ï –•–í–ê–¢–ê–ï–¢!");
        }
        function showToast(m) {
            const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; t.style.transform='translate(-50%,0) scale(1)';
            setTimeout(()=>{t.style.opacity=0; t.style.transform='translate(-50%,0) scale(0.9)';},2000);
        }
        function switchTab(t) {
            ['upgrades','synthesis','casino','blackmarket'].forEach(id=>{
                const b=document.getElementById('tab'+id.charAt(0).toUpperCase()+id.slice(1));
                const c=document.getElementById('content'+id.charAt(0).toUpperCase()+id.slice(1));
                if(id===t) { b.classList.add('tab-active'); b.classList.remove('tab-inactive'); c.classList.remove('hidden'); }
                else { b.classList.add('tab-inactive'); b.classList.remove('tab-active'); c.classList.add('hidden'); }
            });
        }
        function checkSmuggler() {
            const now = Date.now();
            if (!GameState.smuggler.active && now > GameState.smuggler.nextArrival) { GameState.smuggler.active = true; GameState.smuggler.departTime = now + 30000; showToast("–¢–û–†–ì–û–í–ï–¶!"); }
            if (GameState.smuggler.active && now > GameState.smuggler.departTime) { GameState.smuggler.active = false; GameState.smuggler.nextArrival = now + 180000; closeSmuggler(); }
            const btn = document.getElementById('smugglerBtn');
            if(GameState.smuggler.active) { btn.classList.remove('hidden'); document.getElementById('smugglerTimerDisplay').innerText = Math.ceil((GameState.smuggler.departTime - now)/1000) + 's'; document.getElementById('smugglerModalTimer').innerText = Math.ceil((GameState.smuggler.departTime - now)/1000) + 's'; } else { btn.classList.add('hidden'); }
        }
        function openSmuggler() { document.getElementById('smugglerModal').classList.remove('hidden'); }
        function closeSmuggler() { document.getElementById('smugglerModal').classList.add('hidden'); }
        function spinRoulette() {
            const COOLDOWN_MS = 10800000;
            if(Date.now() - GameState.lastSpinTime < COOLDOWN_MS) return;
            document.getElementById('btnSpin').disabled = true;
            const wheel = document.getElementById('rouletteWheel');
            const deg = 1800 + Math.random()*360;
            wheel.style.transition = "transform 4s ease-out"; wheel.style.transform = `rotate(${deg}deg)`;
            setTimeout(() => {
                const r = Math.random(); let prize = 0; let msg = "";
                if(r<0.5) { prize=1000; msg="1,000 –º–≥"; } else if(r<0.8) { prize=5000; msg="5,000 –º–≥"; } else if(r<0.95) { prize=10000; msg="10,000 –º–≥"; } else { prize=50000; msg="–î–ñ–ï–ö–ü–û–¢!"; }
                GameState.balance += prize; GameState.lastSpinTime = Date.now(); showToast(msg); updateUI();
            }, 4000);
        }
        
        // --- CASE OPENING LOGIC ---
        function generateReel(type) {
            const reel = document.getElementById('caseReel');
            reel.innerHTML = '';
            
            let items = [];
            // Probabilities: Common 60%, Uncommon 25%, Rare 10%, Epic 4%, Legendary 1%
            // But influenced by Case Type
            let baseChance = type === 'basic' ? 0 : 20; // Bonus shift for expensive case

            for(let i=0; i<60; i++) { // Generate 60 items
                let rand = Math.random() * 100 + baseChance;
                let rarity, val, className;
                
                if (rand < 50) { rarity="Common"; val=Math.floor(Math.random()*500+100); className="rarity-common"; }
                else if (rand < 80) { rarity="Uncommon"; val=Math.floor(Math.random()*1000+500); className="rarity-uncommon"; }
                else if (rand < 92) { rarity="Rare"; val=Math.floor(Math.random()*3000+1500); className="rarity-rare"; }
                else if (rand < 98) { rarity="Epic"; val=Math.floor(Math.random()*10000+5000); className="rarity-epic"; }
                else { rarity="Legendary"; val=Math.floor(Math.random()*50000+20000); className="rarity-legendary"; }

                // Determine winner at index 45
                if(i === 45) {
                    items.push({val, className, winner: true});
                } else {
                    items.push({val, className, winner: false});
                }
            }
            
            // Build DOM
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `case-item ${item.className}`;
                el.innerHTML = `<span class="text-xs text-gray-400 mb-1">–ú–ì</span><span class="font-bold text-white text-lg">${item.val}</span>`;
                if(item.winner) el.id = 'winnerItem';
                reel.appendChild(el);
            });

            return items[45]; // Return winning object
        }

        function openCase(type) {
            let cost = type==='basic'?2000:20000;
            if(GameState.balance < cost) { showToast("–ù–ï–¢ –î–ï–ù–ï–ì!"); return; }
            GameState.balance -= cost;
            updateUI(); // Immediate deduct

            // Prep
            const winItem = generateReel(type);
            const modal = document.getElementById('caseModal');
            modal.classList.remove('hidden');
            const reel = document.getElementById('caseReel');
            
            // Reset position
            reel.style.transition = 'none';
            reel.style.transform = 'translateX(0px)';
            
            // Trigger reflow
            void reel.offsetWidth;

            // Animate
            // Item width 100px + 10px margin = 110px. 
            // Winner is at index 45. 
            // We want index 45 to be centered. 
            // Center of window (width?) - (45 * 110 + 55).
            // Assuming window width ~350px. Center is 175.
            // Target X = 175 - (45 * 110 + 50) = 175 - 5000 = -4825 (approx)
            // Add some randomness within the card width (+/- 40px)
            const randomOffset = Math.floor(Math.random() * 80) - 40;
            // - (45 items * 110px width) + (container center offset ~ half container width)
            const scrollDist = -(45 * 110) + 150 + randomOffset; 

            setTimeout(() => {
                reel.style.transition = 'transform 5s cubic-bezier(0.15, 0, 0.2, 1)'; // Ease-out spin
                reel.style.transform = `translateX(${scrollDist}px)`;
                
                // Sound effect loop? (Vibration)
                let vibrateInterval = setInterval(() => {
                    tg.HapticFeedback.selectionChanged();
                }, 100);
                // Slow down vibration
                setTimeout(() => { clearInterval(vibrateInterval); vibrateInterval = setInterval(()=>tg.HapticFeedback.selectionChanged(), 200); }, 3000);
                setTimeout(() => { clearInterval(vibrateInterval); vibrateInterval = setInterval(()=>tg.HapticFeedback.selectionChanged(), 400); }, 4000);
                
                setTimeout(() => {
                    clearInterval(vibrateInterval);
                    tg.HapticFeedback.notificationOccurred('success');
                    document.getElementById('caseStatus').innerText = `–í–´–ò–ì–†–´–®: ${winItem.val}`;
                    GameState.balance += winItem.val;
                    saveGame();
                    updateUI();
                    
                    // Close delay
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        document.getElementById('caseStatus').innerText = "–ö–†–£–¢–ò–ú...";
                    }, 2000);
                }, 5000);
            }, 100);
        }

        const clickTarget = document.getElementById('clickTarget');
        clickTarget.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            if (GameState.energy >= 1) {
                let power = GameState.multitapLevel * GameState.multiplier;
                let isCrit = false;
                if(GameState.items.unstableIsotope && Math.random()<0.1) { isCrit=true; power*=5; tg.HapticFeedback.notificationOccurred('warning'); }
                else tg.HapticFeedback.impactOccurred('medium');
                GameState.balance += power; GameState.energy -= 1;
                const el = document.createElement('div'); el.className = 'floating-text' + (isCrit ? ' crit-text' : ''); el.innerText = `+${Math.floor(power)}`; el.style.left = e.clientX+'px'; el.style.top = e.clientY+'px'; document.body.appendChild(el); setTimeout(()=>el.remove(), 800);
                clickTarget.style.transform = `scale(0.95) rotate(${Math.random()*10-5}deg)`; setTimeout(()=>clickTarget.style.transform = 'scale(1)', 50);
                const flask = document.getElementById('clickTarget');
                if(Date.now() < GameState.hulkEndTime) flask.style.color = '#a855f7'; else if(Date.now() < GameState.boostEndTime) flask.style.color = '#ef4444'; else flask.style.color = '#22c55e';
            } else tg.HapticFeedback.notificationOccurred('error');
            updateUI();
        });

        setInterval(()=>{
            if(GameState.energy<GameState.maxEnergy) GameState.energy = Math.min(GameState.maxEnergy, GameState.energy+GameState.energyRechargeRate);
            if(GameState.autobotLevel>0) GameState.balance += GameState.autobotLevel * Upgrades.autobot.powerBase * GameState.multiplier;
            if((GameState.boostEndTime>0 && Date.now()>GameState.boostEndTime) || (GameState.hulkEndTime>0 && Date.now()>GameState.hulkEndTime)) recalcMultiplier();
            checkSmuggler(); updateUI();
            if(Date.now()-GameState.lastSaveTime>5000) saveGame();
        }, 1000);

        initTelegram(); loadGame();
    </script>
</body>
</html>
