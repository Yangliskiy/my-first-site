<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Lab</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #000;
            color: #ffffff;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: background 1s ease-in-out;
            user-select: none;
        }

        /* --- BACKGROUNDS --- */
        .bg-lvl-0 { background: radial-gradient(circle at 50% 30%, #14532d 0%, #020617 70%); }
        .bg-lvl-1 { background: radial-gradient(circle at 50% 30%, #1e3a8a 0%, #020617 70%); }
        .bg-lvl-2 { background: radial-gradient(circle at 50% 30%, #7c2d12 0%, #020617 70%); }
        .bg-lvl-3 { background: radial-gradient(circle at 50% 30%, #0891b2 0%, #020617 70%); }
        .bg-lvl-4 { background: radial-gradient(circle at 50% 30%, #7e22ce 0%, #020617 70%); }

        .cyber-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
            perspective: 500px;
        }
        
        .vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 0%, #000000 100%);
            pointer-events: none;
            z-index: 0;
        }

        /* --- ANIMATIONS --- */
        @keyframes liquid-pulse {
            0%, 100% { filter: drop-shadow(0 0 15px currentColor); transform: scale(1); }
            50% { filter: drop-shadow(0 0 40px currentColor); transform: scale(1.03); }
        }
        .flask-main {
            transition: transform 0.05s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: liquid-pulse 3s infinite;
            color: #22c55e; 
        }
        .flask-main:active { transform: scale(0.90) rotate(5deg); }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-100px) scale(1.5); }
        }
        .floating-text {
            position: absolute;
            color: #4ade80; 
            font-weight: 900;
            font-size: 28px;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            text-shadow: 0 0 10px #22c55e;
            z-index: 50;
            font-family: monospace;
        }
        .crit-text {
            color: #ef4444; 
            font-size: 42px;
            text-shadow: 0 0 20px #b91c1c;
            z-index: 60;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 40;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.8);
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .shop-grid { scrollbar-width: none; -ms-overflow-style: none; }
        .shop-grid::-webkit-scrollbar { display: none; }

        .tab-active {
            background-color: rgba(34, 197, 94, 0.15);
            border-bottom: 2px solid #4ade80;
            color: #4ade80;
            text-shadow: 0 0 8px rgba(74, 222, 128, 0.5);
        }
        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
        
        button:active { transform: scale(0.98); }

        /* --- DRAG & DROP --- */
        .draggable-flask {
            touch-action: none;
            position: relative;
            z-index: 20;
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .draggable-flask.dragging {
            z-index: 100;
            transition: none;
            filter: drop-shadow(0 0 15px currentColor);
            transform: scale(1.2);
        }
        .draggable-flask.pouring {
            transition: all 0.5s ease-in-out;
            z-index: 50;
        }
        .pour-stream {
            position: absolute;
            width: 4px;
            height: 0;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: currentColor;
            opacity: 0.8;
            border-radius: 4px;
            pointer-events: none;
            z-index: 40;
            transition: height 0.2s;
        }
        #mixingPot { transition: transform 0.2s; }
        #mixingPot.receive-liquid { transform: scale(1.1); }
        #mixLiquid { transition: fill 0.3s ease, d 0.3s ease; }

        /* --- CASINO STYLES --- */
        .roulette-wheel {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 4px solid #333;
            background: conic-gradient(
                #ef4444 0deg 60deg, 
                #f59e0b 60deg 120deg, 
                #22c55e 120deg 180deg, 
                #3b82f6 180deg 240deg, 
                #a855f7 240deg 300deg, 
                #ec4899 300deg 360deg
            );
            position: relative;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        .roulette-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; 
            height: 0; 
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 24px solid #fff;
            z-index: 20;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.5));
        }
        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: #111;
            border-radius: 50%;
            border: 2px solid #555;
            z-index: 10;
        }
        
        .shake-box { animation: shake-box 0.5s infinite; }
        @keyframes shake-box {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-screen { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }

        /* --- SMUGGLER STYLES --- */
        #smugglerBtn {
            position: absolute;
            top: 80px;
            right: 10px;
            z-index: 60;
            animation: pulse-smuggler 2s infinite;
        }
        @keyframes pulse-smuggler {
            0% { transform: scale(1); filter: drop-shadow(0 0 5px #a855f7); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 15px #d8b4fe); }
            100% { transform: scale(1); filter: drop-shadow(0 0 5px #a855f7); }
        }
        .smuggler-modal {
            background: rgba(10, 5, 20, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid #7e22ce;
        }
    </style>
</head>
<body id="gameBody" class="h-screen w-full flex flex-col justify-between items-center p-4 bg-lvl-0">
    
    <!-- Background Effects -->
    <div class="cyber-grid"></div>
    <div class="vignette"></div>

    <!-- SMUGGLER BUTTON (Hidden by default) -->
    <div id="smugglerBtn" class="hidden cursor-pointer" onclick="openSmuggler()">
        <div class="w-14 h-14 rounded-full bg-purple-900 border-2 border-purple-500 flex items-center justify-center text-3xl shadow-lg relative">
            üïµÔ∏è‚Äç‚ôÇÔ∏è
            <div class="absolute -bottom-1 -right-1 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full" id="smugglerTimerDisplay">30s</div>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div class="relative z-10 w-full max-w-md flex flex-col h-full justify-between pb-2">
        
        <!-- Header: Stats -->
        <div class="w-full flex justify-between items-center glass-panel rounded-2xl p-4 mb-2 mt-2 border-l-4 border-green-500 relative overflow-hidden">
            <div class="flex flex-col relative z-10">
                <span class="text-xs text-green-400 uppercase tracking-widest font-mono">–°–∫–ª–∞–¥ (–º–≥)</span>
                <div class="flex items-center gap-2">
                    <div id="secretAdminBtn" class="w-6 h-6 rounded bg-green-900/50 border border-green-500 flex items-center justify-center text-xs font-bold text-green-400 cursor-pointer active:scale-90 transition-transform select-none">‚ò£</div>
                    <span id="scoreDisplay" class="text-3xl font-mono font-bold tracking-wider text-green-300 drop-shadow-lg">0</span>
                </div>
                <div class="text-[10px] text-green-600 font-mono mt-1" id="passiveDisplay">0 –º–≥/—Å–µ–∫</div>
            </div>
            <div class="text-right relative z-10">
                <span class="text-xs text-gray-400 uppercase tracking-widest font-mono">–õ–æ–∫–∞—Ü–∏—è</span>
                <div id="levelDisplay" class="text-green-400 font-bold tracking-wide text-sm transition-all text-shadow-glow">–ü–æ–¥–≤–∞–ª</div>
                <div id="multiplierDisplay" class="text-xs text-yellow-500 font-bold mt-1 opacity-0 transition-opacity">–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x1</div>
                <div id="boostTimer" class="text-xs text-red-500 font-bold mt-1 hidden animate-pulse">–ë–£–°–¢: 30s</div>
            </div>
            
            <div id="critFlash" class="absolute inset-0 bg-red-500/20 opacity-0 pointer-events-none transition-opacity duration-100"></div>
        </div>

        <!-- Game Area: The Flask (CLICKER) -->
        <div id="clickerArea" class="flex-grow flex items-center justify-center relative w-full perspective-container min-h-0">
            <div id="clickTarget" class="flask-main w-64 h-64 flex items-center justify-center cursor-pointer select-none relative group tap-highlight-transparent z-10">
                <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-[0_0_25px_currentColor]">
                    <defs>
                        <linearGradient id="liquidGrad" x1="0%" y1="100%" x2="0%" y2="0%">
                            <stop offset="0%" stop-color="currentColor" stop-opacity="1" />
                            <stop offset="100%" stop-color="#ffffff" stop-opacity="0.5" />
                        </linearGradient>
                    </defs>
                    <path d="M75,20 L125,20 L125,70 L160,130 C170,145 170,180 145,180 L55,180 C30,180 30,145 40,130 L75,70 Z" 
                          fill="rgba(255,255,255,0.05)" stroke="currentColor" stroke-width="4" stroke-linejoin="round"/>
                    <path d="M80,80 L120,80 L148,130 C155,142 155,170 140,170 L60,170 C45,170 45,142 52,130 Z" 
                          fill="currentColor" class="opacity-80"/>
                    <circle cx="100" cy="150" r="5" fill="#fff" opacity="0.4">
                        <animate attributeName="cy" values="150;120" dur="2s" repeatCount="indefinite" />
                        <animate attributeName="opacity" values="0.4;0" dur="2s" repeatCount="indefinite" />
                    </circle>
                </svg>
            </div>
        </div>

        <!-- Energy Bar -->
        <div class="w-full mb-3 px-2">
            <div class="flex justify-between text-sm mb-1 font-bold text-green-300 font-mono">
                <span>‚ö° –†–µ–∞–∫—Ç–æ—Ä</span>
                <span id="energyText">1000 / 1000</span>
            </div>
            <div class="w-full h-4 bg-black rounded border border-green-900 overflow-hidden relative shadow-[0_0_10px_rgba(34,197,94,0.3)]">
                <div class="absolute inset-0 opacity-20 bg-[repeating-linear-gradient(45deg,transparent,transparent_10px,#000_10px,#000_20px)] z-10"></div>
                <div id="energyBar" class="h-full bg-gradient-to-r from-green-900 via-green-600 to-green-400 transition-all duration-300 relative z-0" style="width: 100%"></div>
            </div>
        </div>

        <!-- Shop / Upgrades Panel -->
        <div class="glass-panel rounded-xl flex flex-col h-[40vh] overflow-hidden border-t border-white/10 relative z-30">
            <!-- Tabs -->
            <div class="flex border-b border-white/10 bg-black/20 overflow-x-auto shrink-0">
                <button onclick="switchTab('upgrades')" id="tabUpgrades" class="flex-1 py-3 px-2 text-[10px] md:text-sm font-bold uppercase tracking-wider transition-all tab-active">
                    –¶–µ—Ö
                </button>
                <button onclick="switchTab('synthesis')" id="tabSynthesis" class="flex-1 py-3 px-2 text-[10px] md:text-sm font-bold uppercase tracking-wider transition-all tab-inactive">
                    –°–∏–Ω—Ç–µ–∑
                </button>
                <button onclick="switchTab('casino')" id="tabCasino" class="flex-1 py-3 px-2 text-[10px] md:text-sm font-bold uppercase tracking-wider transition-all tab-inactive text-yellow-400">
                    –£–¥–∞—á–∞
                </button>
                <button onclick="switchTab('blackmarket')" id="tabBlackmarket" class="flex-1 py-3 px-2 text-[10px] md:text-sm font-bold uppercase tracking-wider transition-all tab-inactive text-red-400">
                    –ß.–†—ã–Ω–æ–∫
                </button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto shop-grid p-2 relative h-full">
                
                <!-- 1. UPGRADES TAB -->
                <div id="contentUpgrades" class="space-y-2">
                    <button onclick="buyUpgrade('location')" id="btnLocation" class="w-full group relative overflow-hidden bg-gradient-to-r from-green-900/40 to-blue-900/40 border border-green-500/30 hover:border-green-400/60 active:scale-95 rounded-xl p-3 text-left transition-all shadow-lg mb-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl drop-shadow-md">üèóÔ∏è</div>
                                <div>
                                    <div class="text-xs text-green-100 uppercase font-bold tracking-widest">–ü–µ—Ä–µ–µ–∑–¥</div>
                                    <div class="text-[10px] text-gray-300 font-mono">–î–æ—Ö–æ–¥ x2</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-mono text-white text-xs font-bold" id="nextLocName">–ì–∞—Ä–∞–∂</div>
                                <div class="text-green-400 text-xs font-mono mt-1 font-bold" id="costLocation">5,000 –º–≥</div>
                            </div>
                        </div>
                    </button>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="buyUpgrade('multitap')" class="bg-white/5 border border-white/10 rounded-lg p-2 text-left h-20 flex flex-col justify-between">
                            <div class="text-[10px] text-green-500 uppercase font-bold">–°–∏–Ω—Ç–µ–∑</div>
                            <div class="font-mono text-white text-xs">–£—Ä. <span id="lvlMultitap">1</span></div>
                            <div class="text-gray-400 text-[10px] font-mono" id="costMultitap">100 –º–≥</div>
                        </button>
                        <button onclick="buyUpgrade('energy')" class="bg-white/5 border border-white/10 rounded-lg p-2 text-left h-20 flex flex-col justify-between">
                            <div class="text-[10px] text-purple-400 uppercase font-bold">–ï–º–∫–æ—Å—Ç—å</div>
                            <div class="font-mono text-white text-xs">–£—Ä. <span id="lvlEnergy">1</span></div>
                            <div class="text-gray-400 text-[10px] font-mono" id="costEnergy">100 –º–≥</div>
                        </button>
                        <button onclick="buyUpgrade('recharge')" class="bg-white/5 border border-white/10 rounded-lg p-2 text-left h-20 flex flex-col justify-between">
                            <div class="text-[10px] text-blue-400 uppercase font-bold">–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ</div>
                            <div class="font-mono text-white text-xs">–£—Ä. <span id="lvlRecharge">1</span></div>
                            <div class="text-gray-400 text-[10px] font-mono" id="costRecharge">100 –º–≥</div>
                        </button>
                        <button onclick="buyUpgrade('autobot')" class="bg-white/5 border border-white/10 rounded-lg p-2 text-left h-20 flex flex-col justify-between">
                            <div class="text-[10px] text-yellow-500 uppercase font-bold">–ê–≤—Ç–æ-–í–∞—Ä–∫–∞</div>
                            <div class="font-mono text-white text-xs">–£—Ä. <span id="lvlAutobot">0</span></div>
                            <div class="text-gray-400 text-[10px] font-mono" id="costAutobot">500 –º–≥</div>
                        </button>
                    </div>
                </div>

                <!-- 2. SYNTHESIS MINIGAME TAB -->
                <div id="contentSynthesis" class="hidden h-full flex flex-col items-center select-none touch-none">
                    <div class="w-full bg-white/5 rounded-lg p-2 text-center border border-white/10 mb-2 shrink-0">
                        <div class="flex items-center justify-center gap-2">
                            <div id="targetColorSample" class="w-4 h-4 rounded-full border border-white/50 shadow-[0_0_10px_currentColor]"></div>
                            <span id="targetColorName" class="font-bold text-sm font-mono tracking-widest">–§–ò–û–õ–ï–¢–û–í–´–ô</span>
                        </div>
                    </div>
                    <div class="flex-grow w-full relative flex flex-col items-center justify-between py-4">
                        <div id="mixingPot" class="relative w-32 h-32 flex items-center justify-center transition-transform">
                            <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] pointer-events-none">
                                <path d="M20,20 L80,20 L80,80 C80,90 70,95 50,95 C30,95 20,90 20,80 Z" fill="rgba(255,255,255,0.1)" stroke="white" stroke-width="2"/>
                                <path id="mixLiquid" d="M22,88 L78,88 L78,90 C78,92 68,93 50,93 C32,93 22,92 22,90 Z" fill="#111" class="mix-liquid"/>
                            </svg>
                        </div>
                        <div class="w-full grid grid-cols-3 gap-8 px-4 h-24 items-end mb-4">
                            <div class="flex flex-col items-center">
                                <div class="draggable-flask w-16 h-20 cursor-grab active:cursor-grabbing text-red-500" data-color="red">
                                    <div class="pour-stream"></div>
                                    <svg viewBox="0 0 50 80" class="w-full h-full drop-shadow-[0_0_10px_currentColor] pointer-events-none">
                                        <path d="M15,2 L35,2 L35,20 L45,70 C48,78 40,78 25,78 C10,78 2,78 5,70 L15,20 Z" fill="rgba(255,0,0,0.2)" stroke="currentColor" stroke-width="2"/>
                                        <path d="M16,20 L34,20 L44,70 C46,76 40,76 25,76 C10,76 4,76 6,70 Z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <span class="text-[10px] font-bold text-red-400 mt-2">RED</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="draggable-flask w-16 h-20 cursor-grab active:cursor-grabbing text-green-500" data-color="green">
                                    <div class="pour-stream"></div>
                                    <svg viewBox="0 0 50 80" class="w-full h-full drop-shadow-[0_0_10px_currentColor] pointer-events-none">
                                        <path d="M15,2 L35,2 L35,20 L45,70 C48,78 40,78 25,78 C10,78 2,78 5,70 L15,20 Z" fill="rgba(0,255,0,0.2)" stroke="currentColor" stroke-width="2"/>
                                        <path d="M16,20 L34,20 L44,70 C46,76 40,76 25,76 C10,76 4,76 6,70 Z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <span class="text-[10px] font-bold text-green-400 mt-2">GRN</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="draggable-flask w-16 h-20 cursor-grab active:cursor-grabbing text-blue-500" data-color="blue">
                                    <div class="pour-stream"></div>
                                    <svg viewBox="0 0 50 80" class="w-full h-full drop-shadow-[0_0_10px_currentColor] pointer-events-none">
                                        <path d="M15,2 L35,2 L35,20 L45,70 C48,78 40,78 25,78 C10,78 2,78 5,70 L15,20 Z" fill="rgba(0,0,255,0.2)" stroke="currentColor" stroke-width="2"/>
                                        <path d="M16,20 L34,20 L44,70 C46,76 40,76 25,76 C10,76 4,76 6,70 Z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <span class="text-[10px] font-bold text-blue-400 mt-2">BLU</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="resetMix()" class="text-xs text-gray-500 underline mb-4 absolute top-2 right-2">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    <div id="synthesisCooldown" class="absolute inset-0 bg-black/95 z-50 flex flex-col items-center justify-center text-center hidden backdrop-blur-md rounded-lg">
                        <div class="text-4xl mb-4">‚è≥</div>
                        <div class="text-gray-300 font-bold text-lg uppercase tracking-wider">–†–µ–∞–∫—Ç–æ—Ä –æ—Å—Ç—ã–≤–∞–µ—Ç</div>
                        <div id="cooldownTimer" class="text-3xl font-mono text-green-400 font-bold mt-4 shadow-green-500/50 drop-shadow-lg">00:00</div>
                    </div>
                </div>

                <!-- 3. CASINO & CASES TAB -->
                <div id="contentCasino" class="hidden h-full flex flex-col items-center space-y-4">
                    <!-- Daily Roulette -->
                    <div class="w-full bg-white/5 rounded-xl p-3 border border-white/10 relative overflow-hidden flex flex-col items-center">
                        <div class="text-xs text-yellow-400 uppercase font-bold tracking-widest mb-2">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –†—É–ª–µ—Ç–∫–∞</div>
                        <div class="relative mb-2">
                            <div class="roulette-pointer"></div>
                            <div class="roulette-wheel" id="rouletteWheel"></div>
                            <div class="roulette-center"></div>
                        </div>
                        <button id="btnSpin" onclick="spinRoulette()" class="bg-yellow-500 text-black font-bold py-2 px-6 rounded-full uppercase tracking-widest shadow-lg hover:bg-yellow-400 active:scale-95 transition">
                            –ö–†–£–¢–ò–¢–¨
                        </button>
                        <div id="spinTimer" class="text-xs text-gray-400 mt-2 hidden">–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: <span id="spinTimeVal">00:00:00</span></div>
                    </div>
                    <!-- Cases -->
                    <div class="w-full grid grid-cols-2 gap-2">
                        <button onclick="openCase('basic')" class="bg-gray-800 border border-gray-600 p-2 rounded-xl flex flex-col items-center relative overflow-hidden active:scale-95 transition" id="caseBasic">
                            <div class="text-4xl mb-1">üì¶</div>
                            <div class="text-[10px] text-gray-400 uppercase font-bold">–°—ã—Ä—å–µ–≤–æ–π –Ø—â–∏–∫</div>
                            <div class="text-green-400 text-xs font-mono font-bold mt-1">2,000 –º–≥</div>
                        </button>
                        <button onclick="openCase('neon')" class="bg-gray-900 border border-purple-500 p-2 rounded-xl flex flex-col items-center relative overflow-hidden active:scale-95 transition shadow-[0_0_10px_rgba(168,85,247,0.3)]" id="caseNeon">
                            <div class="text-4xl mb-1">üîí</div>
                            <div class="text-[10px] text-purple-400 uppercase font-bold">–ö–∏–±–µ—Ä-–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</div>
                            <div class="text-purple-300 text-xs font-mono font-bold mt-1">20,000 –º–≥</div>
                        </button>
                    </div>
                </div>

                <!-- 4. BLACK MARKET TAB -->
                <div id="contentBlackmarket" class="hidden space-y-3">
                    <button onclick="buyItem('unstableIsotope')" id="btnIsotope" class="w-full bg-red-900/10 border border-red-800/50 rounded-lg p-3 text-left flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="text-xl">‚ò¢Ô∏è</div>
                            <div>
                                <div class="text-xs text-red-400 uppercase font-bold">–ò–∑–æ—Ç–æ–ø</div>
                                <div class="text-[10px] text-gray-500">–ö—Ä–∏—Ç x5</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-red-300 text-xs font-mono font-bold" id="costIsotope">2,500</div>
                            <div id="statusIsotope" class="text-[10px] text-green-500 font-bold hidden">–ö–£–ü–õ–ï–ù–û</div>
                        </div>
                    </button>
                    <button onclick="buyItem('blueCrystal')" id="btnCrystal" class="w-full bg-cyan-900/10 border border-cyan-800/50 rounded-lg p-3 text-left flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="text-xl">üíé</div>
                            <div>
                                <div class="text-xs text-cyan-400 uppercase font-bold">–ö—Ä–∏—Å—Ç–∞–ª–ª</div>
                                <div class="text-[10px] text-gray-500">–î–æ—Ö–æ–¥ x2</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-cyan-300 text-xs font-mono font-bold" id="costCrystal">10,000</div>
                            <div id="statusCrystal" class="text-[10px] text-green-500 font-bold hidden">–ö–£–ü–õ–ï–ù–û</div>
                        </div>
                    </button>
                    <button onclick="buyItem('darkMatter')" id="btnDarkMatter" class="w-full bg-fuchsia-900/10 border border-fuchsia-800/50 rounded-lg p-3 text-left flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="text-xl">üåå</div>
                            <div>
                                <div class="text-xs text-fuchsia-400 uppercase font-bold">–ú–∞—Ç–µ—Ä–∏—è</div>
                                <div class="text-[10px] text-gray-500">–î–æ—Ö–æ–¥ x5</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-fuchsia-300 text-xs font-mono font-bold" id="costDarkMatter">100k</div>
                            <div id="statusDarkMatter" class="text-[10px] text-green-500 font-bold hidden">–ö–£–ü–õ–ï–ù–û</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SMUGGLER MODAL -->
    <div id="smugglerModal" class="fixed inset-0 z-[100] hidden flex flex-col justify-center items-center p-4 bg-black/90 backdrop-blur-xl">
        <div class="smuggler-modal w-full max-w-sm rounded-2xl p-5 relative overflow-hidden shadow-[0_0_50px_rgba(168,85,247,0.3)]">
            <button class="absolute top-2 right-3 text-gray-400 text-2xl" onclick="closeSmuggler()">‚úï</button>
            
            <div class="text-center mb-4">
                <div class="text-6xl mb-2">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
                <h2 class="text-xl font-bold text-purple-400 uppercase tracking-widest">–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∏—Å—Ç</h2>
                <div class="text-xs text-gray-400">–£—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑: <span id="smugglerModalTimer" class="text-red-500 font-mono">30s</span></div>
            </div>

            <div class="space-y-3">
                <!-- Legendary Item 1 -->
                <button onclick="buyLegendary('hulkSerum')" class="w-full bg-green-900/20 border border-green-500/50 rounded-xl p-3 flex items-center gap-3 hover:bg-green-900/40 transition">
                    <div class="text-3xl">üß™</div>
                    <div class="text-left flex-1">
                        <div class="text-green-300 font-bold text-sm">–°—ã–≤–æ—Ä–æ—Ç–∫–∞ –•–∞–ª–∫–∞</div>
                        <div class="text-[10px] text-gray-400">–ö–ª–∏–∫ x50 –Ω–∞ 60 —Å–µ–∫</div>
                    </div>
                    <div class="text-right">
                        <div class="text-yellow-400 font-mono font-bold text-sm">50k</div>
                    </div>
                </button>

                <!-- Legendary Item 2 -->
                <button onclick="buyLegendary('timeLoop')" class="w-full bg-blue-900/20 border border-blue-500/50 rounded-xl p-3 flex items-center gap-3 hover:bg-blue-900/40 transition">
                    <div class="text-3xl">‚è≥</div>
                    <div class="text-left flex-1">
                        <div class="text-blue-300 font-bold text-sm">–ü–µ—Ç–ª—è –í—Ä–µ–º–µ–Ω–∏</div>
                        <div class="text-[10px] text-gray-400">+4 —á–∞—Å–∞ –¥–æ—Ö–æ–¥–∞</div>
                    </div>
                    <div class="text-right">
                        <div class="text-yellow-400 font-mono font-bold text-sm">100k</div>
                    </div>
                </button>

                <!-- Legendary Item 3 -->
                <button onclick="buyLegendary('unicornTear')" class="w-full bg-pink-900/20 border border-pink-500/50 rounded-xl p-3 flex items-center gap-3 hover:bg-pink-900/40 transition">
                    <div class="text-3xl">üíé</div>
                    <div class="text-left flex-1">
                        <div class="text-pink-300 font-bold text-sm">–°–ª–µ–∑–∞ –ï–¥–∏–Ω–æ—Ä–æ–≥–∞</div>
                        <div class="text-[10px] text-gray-400">–í–µ—á–Ω—ã–π x5 (Stack)</div>
                    </div>
                    <div class="text-right">
                        <div class="text-yellow-400 font-mono font-bold text-sm">1M</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-900/90 border border-red-500 text-red-100 px-6 py-3 rounded shadow-lg opacity-0 pointer-events-none text-sm font-bold font-mono uppercase transition-opacity z-[200] whitespace-nowrap">
        Msg
    </div>

    <script>
        // --- Game State ---
        const GameState = {
            balance: 0,
            energy: 1000,
            maxEnergy: 1000,
            energyRechargeRate: 3, 
            multitapLevel: 1,
            energyLevel: 1,
            rechargeLevel: 1,
            autobotLevel: 0,
            locationLevel: 0,
            hasCrit: false,
            multiplier: 1,
            permMultiplier: 1, // Base multiplier from items
            items: { unstableIsotope: false, blueCrystal: false, darkMatter: false },
            boostEndTime: 0, // General boost
            hulkEndTime: 0, // Legendary boost
            synthesisCooldown: 0,
            lastSpinTime: 0,
            smuggler: {
                active: false,
                departTime: 0,
                nextArrival: Date.now() + 60000 // First arrival in 1 min
            },
            lastSaveTime: Date.now()
        };

        const LocationNames = ["–ü–æ–¥–≤–∞–ª", "–ì–∞—Ä–∞–∂", "–ó–∞–≤–æ–¥", "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", "–ö–æ—Å–º–æ—Å"];

        const Upgrades = {
            multitap: { baseCost: 100, costMultiplier: 2.0, powerBase: 1 },
            energy: { baseCost: 100, costMultiplier: 1.5, powerBase: 500 },
            recharge: { baseCost: 300, costMultiplier: 1.8, powerBase: 1 }, 
            autobot: { baseCost: 500, costMultiplier: 2.5, powerBase: 1 },
            location: { baseCost: 5000, costMultiplier: 5.0, powerBase: 1 } 
        };

        const SpecialItems = {
            unstableIsotope: { cost: 2500 },
            blueCrystal: { cost: 10000 },
            darkMatter: { cost: 100000 }
        };

        let currentBgLevel = -1;
        const tg = window.Telegram.WebApp;

        // --- Synthesis Logic ---
        let currentMix = [];
        let targetMix = "";
        const MixRecipes = {
            "purple": ["red", "blue"],
            "yellow": ["red", "green"],
            "cyan": ["green", "blue"],
            "white": ["red", "green", "blue"]
        };
        const ColorNames = {
            "purple": {name: "–§–ò–û–õ–ï–¢–û–í–´–ô", hex: "#a855f7"},
            "yellow": {name: "–ñ–ï–õ–¢–´–ô", hex: "#eab308"},
            "cyan": {name: "–ë–ò–†–Æ–ó–û–í–´–ô", hex: "#06b6d4"},
            "white": {name: "–ë–ï–õ–´–ô", hex: "#ffffff"}
        };

        function initTelegram() {
            tg.expand();
            tg.ready();
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#000000');
        }

        function loadGame() {
            const saved = localStorage.getItem('neonLabSave_v14'); // Bump version
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(GameState, parsed);
                // Ensure new fields exist
                if(!GameState.smuggler) GameState.smuggler = { active: false, departTime: 0, nextArrival: Date.now() + 60000 };
                if(!GameState.permMultiplier) GameState.permMultiplier = 1;
                if(!GameState.hulkEndTime) GameState.hulkEndTime = 0;
            }
            recalcMultiplier();
            initSynthesis(); 
            initDraggableFlasks(); 
            updateUI();
        }

        function recalcMultiplier() {
            let mult = 1;
            // Base Perm Multipliers
            if(GameState.items.blueCrystal) mult *= 2;
            if(GameState.items.darkMatter) mult *= 5;
            // Extra Perm from Unicorn Tear
            mult *= GameState.permMultiplier; 

            // Location
            if (GameState.locationLevel > 0) mult *= Math.pow(2, GameState.locationLevel);
            
            // Temp Boosts
            if (Date.now() < GameState.boostEndTime) mult *= 10; 
            if (Date.now() < GameState.hulkEndTime) mult *= 50; // HULK SMASH

            GameState.multiplier = mult;
        }

        function saveGame() {
            GameState.lastSaveTime = Date.now();
            localStorage.setItem('neonLabSave_v14', JSON.stringify(GameState));
        }

        // --- SMUGGLER LOGIC ---
        function checkSmuggler() {
            const now = Date.now();
            
            // Activate
            if (!GameState.smuggler.active && now > GameState.smuggler.nextArrival) {
                GameState.smuggler.active = true;
                GameState.smuggler.departTime = now + 30000; // Stays for 30s
                showToast("–¢–ê–ò–ù–°–¢–í–ï–ù–ù–´–ô –¢–û–†–ì–û–í–ï–¶ –ü–†–ò–ë–´–õ!");
                tg.HapticFeedback.notificationOccurred('success');
            }

            // Deactivate
            if (GameState.smuggler.active && now > GameState.smuggler.departTime) {
                GameState.smuggler.active = false;
                GameState.smuggler.nextArrival = now + 180000; // Returns in 3 mins
                closeSmuggler();
            }

            // UI Update
            const btn = document.getElementById('smugglerBtn');
            const timerDisplay = document.getElementById('smugglerTimerDisplay');
            const modalTimer = document.getElementById('smugglerModalTimer');
            
            if (GameState.smuggler.active) {
                btn.classList.remove('hidden');
                const left = Math.ceil((GameState.smuggler.departTime - now) / 1000);
                timerDisplay.innerText = left + 's';
                modalTimer.innerText = left + 's';
            } else {
                btn.classList.add('hidden');
            }
        }

        function openSmuggler() {
            document.getElementById('smugglerModal').classList.remove('hidden');
        }

        function closeSmuggler() {
            document.getElementById('smugglerModal').classList.add('hidden');
        }

        function buyLegendary(type) {
            let cost = 0;
            if (type === 'hulkSerum') cost = 50000;
            if (type === 'timeLoop') cost = 100000;
            if (type === 'unicornTear') cost = 1000000;

            if (GameState.balance >= cost) {
                GameState.balance -= cost;
                
                if (type === 'hulkSerum') {
                    GameState.hulkEndTime = Date.now() + 60000;
                    showToast("–°–´–í–û–†–û–¢–ö–ê –•–ê–õ–ö–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê!");
                }
                if (type === 'timeLoop') {
                    const passivePerSec = GameState.autobotLevel * Upgrades.autobot.powerBase * GameState.multiplier;
                    const gain = passivePerSec * 14400; // 4 hours
                    GameState.balance += Math.max(10000, gain); // Min 10k
                    showToast("–í–†–ï–ú–Ø –ü–ï–†–ï–ú–û–¢–ê–ù–û!");
                }
                if (type === 'unicornTear') {
                    GameState.permMultiplier *= 5;
                    showToast("–õ–ï–ì–ï–ù–î–ê–†–ù–û–ï –£–°–ò–õ–ï–ù–ò–ï!");
                }

                recalcMultiplier();
                tg.HapticFeedback.notificationOccurred('success');
                closeSmuggler();
            } else {
                showToast("–ù–ï –•–í–ê–¢–ê–ï–¢ –°–†–ï–î–°–¢–í!");
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // --- CASINO LOGIC ---
        function spinRoulette() {
            if (Date.now() - GameState.lastSpinTime < 86400000) {
                showToast("–†—É–ª–µ—Ç–∫–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞!");
                return;
            }

            const btn = document.getElementById('btnSpin');
            btn.disabled = true;
            btn.style.opacity = 0.5;

            const wheel = document.getElementById('rouletteWheel');
            const spins = 5; 
            const deg = Math.floor(Math.random() * 360);
            const totalDeg = (spins * 360) + deg;
            
            wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
            wheel.style.transform = `rotate(${totalDeg}deg)`;

            setTimeout(() => {
                const actualDeg = totalDeg % 360; 
                const winningAngle = (360 - actualDeg) % 360;
                const segment = Math.floor(winningAngle / 60);
                giveRoulettePrize(segment);
                GameState.lastSpinTime = Date.now();
                saveGame();
                updateUI();
            }, 4000);
        }

        function giveRoulettePrize(segment) {
            let msg = "";
            let amount = 0;
            switch(segment) {
                case 0: amount = 500; msg = "–ü—Ä–∏–∑: 500 –º–≥"; break;
                case 1: amount = 1000; msg = "–ü—Ä–∏–∑: 1,000 –º–≥"; break;
                case 2: GameState.energy = GameState.maxEnergy; msg = "–ü–û–õ–ù–ê–Ø –≠–ù–ï–†–ì–ò–Ø!"; break;
                case 3: amount = 5000; msg = "–ü—Ä–∏–∑: 5,000 –º–≥"; break;
                case 4: amount = 10000; msg = "–ë–ò–ì –í–ò–ù: 10,000 –º–≥"; break;
                case 5: amount = 50000; msg = "–î–ñ–ï–ö–ü–û–¢: 50,000 –º–≥!"; break;
            }
            if (amount > 0) GameState.balance += amount;
            showToast(msg);
            tg.HapticFeedback.notificationOccurred('success');
            createParticles(window.innerWidth/2, window.innerHeight/2);
        }

        function openCase(type) {
            let cost = 0;
            let minPrize = 0;
            let maxPrize = 0;
            if (type === 'basic') { cost = 2000; minPrize = 100; maxPrize = 4000; }
            if (type === 'neon') { cost = 20000; minPrize = 1000; maxPrize = 100000; }
            
            if (GameState.balance < cost) {
                showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤!");
                return;
            }
            GameState.balance -= cost;
            const btn = document.getElementById(type === 'basic' ? 'caseBasic' : 'caseNeon');
            btn.classList.add('shake-box');
            
            setTimeout(() => {
                btn.classList.remove('shake-box');
                const prize = Math.floor(Math.random() * (maxPrize - minPrize + 1)) + minPrize;
                GameState.balance += prize;
                if (prize > cost) {
                    showToast(`–í–´–ò–ì–†–´–®: +${prize.toLocaleString()} –º–≥!`);
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    showToast(`–ù–∞–π–¥–µ–Ω–æ: ${prize.toLocaleString()} –º–≥`);
                    tg.HapticFeedback.notificationOccurred('warning');
                }
                saveGame();
                updateUI();
            }, 500);
        }

        // --- MINIGAME LOGIC ---
        function initSynthesis() {
            const keys = Object.keys(MixRecipes);
            targetMix = keys[Math.floor(Math.random() * keys.length)];
            const info = ColorNames[targetMix];
            document.getElementById('targetColorName').innerText = info.name;
            document.getElementById('targetColorName').style.color = info.hex;
            document.getElementById('targetColorSample').style.backgroundColor = info.hex;
            resetMix();
        }

        function addToMix(color) {
            if (currentMix.includes(color)) return; 
            if (currentMix.length >= 3) return; 
            currentMix.push(color);
            updateMixVisuals();
            checkSynthesis();
        }

        function resetMix() {
            currentMix = [];
            updateMixVisuals();
        }

        function updateMixVisuals() {
            const liquid = document.getElementById('mixLiquid');
            if (currentMix.length === 0) {
                liquid.style.fill = "#111";
                liquid.setAttribute('d', "M22,88 L78,88 L78,90 C78,92 68,93 50,93 C32,93 22,92 22,90 Z"); 
            } else {
                let r=0, g=0, b=0;
                currentMix.forEach(c => {
                    if(c==='red') r=255;
                    if(c==='green') g=255;
                    if(c==='blue') b=255;
                });
                if(currentMix.includes('red') && currentMix.includes('blue')) { r=200; b=200; }
                if(currentMix.includes('red') && currentMix.includes('green')) { r=200; g=200; }
                if(currentMix.includes('green') && currentMix.includes('blue')) { g=200; b=200; }
                if(currentMix.length === 3) { r=255; g=255; b=255; }
                liquid.style.fill = `rgb(${r},${g},${b})`;
                const level = 88 - (currentMix.length * 15);
                liquid.setAttribute('d', `M22,${level} L78,${level} L78,80 C78,88 68,93 50,93 C32,93 22,88 22,80 Z`);
            }
        }

        function checkSynthesis() {
            const recipe = MixRecipes[targetMix];
            const s1 = [...currentMix].sort().join(',');
            const s2 = [...recipe].sort().join(',');
            if (s1 === s2) {
                activateBoost();
            } else if (currentMix.length >= recipe.length) {
                showToast("–°–ú–ï–°–¨ –ù–ï–°–¢–ê–ë–ò–õ–¨–ù–ê!");
                tg.HapticFeedback.notificationOccurred('error');
                setTimeout(resetMix, 500);
            }
        }

        function activateBoost() {
            GameState.boostEndTime = Date.now() + 30000; 
            GameState.synthesisCooldown = Date.now() + 300000; 
            recalcMultiplier();
            showToast("–°–ò–ù–¢–ï–ó –£–°–ü–ï–®–ï–ù! –ê–î–†–ï–ù–ê–õ–ò–ù x10!");
            tg.HapticFeedback.notificationOccurred('success');
            switchTab('upgrades');
            initSynthesis();
            saveGame();
        }

        function initDraggableFlasks() {
            const flasks = document.querySelectorAll('.draggable-flask');
            const mixingPot = document.getElementById('mixingPot');
            flasks.forEach(flask => {
                let startX, startY;
                const handleStart = (e) => {
                    if (Date.now() < GameState.synthesisCooldown || flask.classList.contains('pouring')) return;
                    e.preventDefault(); 
                    const touch = e.touches ? e.touches[0] : e;
                    startX = touch.clientX;
                    startY = touch.clientY;
                    flask.classList.add('dragging');
                    tg.HapticFeedback.selectionChanged();
                };
                const handleMove = (e) => {
                    if (!flask.classList.contains('dragging')) return;
                    e.preventDefault();
                    const touch = e.touches ? e.touches[0] : e;
                    const deltaX = touch.clientX - startX;
                    const deltaY = touch.clientY - startY;
                    flask.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1.2)`;
                    const rect1 = flask.getBoundingClientRect();
                    const rect2 = mixingPot.getBoundingClientRect();
                    if (isOverlapping(rect1, rect2)) mixingPot.classList.add('receive-liquid');
                    else mixingPot.classList.remove('receive-liquid');
                };
                const handleEnd = (e) => {
                    if (!flask.classList.contains('dragging')) return;
                    flask.classList.remove('dragging');
                    mixingPot.classList.remove('receive-liquid');
                    const rect1 = flask.getBoundingClientRect();
                    const rect2 = mixingPot.getBoundingClientRect();
                    if (isOverlapping(rect1, rect2)) {
                        const color = flask.dataset.color;
                        if (!currentMix.includes(color) && currentMix.length < 3) animatePour(flask, mixingPot, color);
                        else resetFlaskPos(flask);
                    } else resetFlaskPos(flask);
                };
                flask.addEventListener('touchstart', handleStart, {passive: false});
                flask.addEventListener('touchmove', handleMove, {passive: false});
                flask.addEventListener('touchend', handleEnd);
                flask.addEventListener('mousedown', handleStart);
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleEnd);
            });
        }

        function isOverlapping(rect1, rect2) {
            return !(rect1.right < rect2.left || rect1.left > rect2.right || rect1.bottom < rect2.top || rect1.top > rect2.bottom);
        }

        function resetFlaskPos(flask) {
            flask.style.transform = `translate(0px, 0px) scale(1)`;
        }

        function animatePour(flask, pot, color) {
            flask.classList.add('pouring');
            flask.style.transform = flask.style.transform + " rotate(-45deg)";
            const stream = flask.querySelector('.pour-stream');
            stream.style.height = "60px"; 
            tg.HapticFeedback.impactOccurred('medium');
            setTimeout(() => {
                addToMix(color);
                stream.style.height = "0";
                setTimeout(() => {
                    flask.style.transform = `translate(0px, 0px) scale(1)`;
                    flask.classList.remove('pouring');
                }, 300);
            }, 400); 
        }

        // --- Main Gameplay ---
        let adminClickCount = 0;
        let adminClickTimer;
        document.getElementById('secretAdminBtn').addEventListener('click', () => {
            adminClickCount++;
            clearTimeout(adminClickTimer);
            adminClickTimer = setTimeout(() => { adminClickCount = 0; }, 1000);
            if (adminClickCount >= 10) {
                // ADMIN: ALSO RESET SMUGGLER TIMER FOR TESTING
                GameState.balance += 1000000000;
                GameState.smuggler.nextArrival = Date.now(); // FORCE ARRIVAL
                saveGame();
                updateUI();
                showToast("‚ö†Ô∏è ADMIN: +1B & SMUGGLER ‚ö†Ô∏è");
                adminClickCount = 0;
            }
        });

        const clickTarget = document.getElementById('clickTarget');
        clickTarget.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            if (GameState.energy >= 1) handleTap(e);
            else {
                clickTarget.style.transform = "translateX(5px) rotate(5deg)";
                setTimeout(() => clickTarget.style.transform = "none", 100);
                tg.HapticFeedback.notificationOccurred('error');
            }
        });

        function handleTap(e) {
            let power = GameState.multitapLevel * GameState.multiplier;
            let isCrit = false;
            
            if (GameState.items.unstableIsotope && Math.random() < 0.1) {
                isCrit = true;
                power *= 5;
                tg.HapticFeedback.notificationOccurred('warning');
                createFloatingText(e.clientX, e.clientY, `CRIT +${Math.floor(power)}`, true);
            } else {
                tg.HapticFeedback.impactOccurred('medium');
                createFloatingText(e.clientX, e.clientY, `+${Math.floor(power)}`, false);
            }
            
            if (GameState.energy < GameState.multitapLevel) return;

            GameState.balance += power;
            GameState.energy -= GameState.multitapLevel;
            
            clickTarget.style.transform = `scale(0.95) rotate(0deg)`;
            setTimeout(() => { clickTarget.style.transform = 'scale(1)'; }, 80);
            createParticles(e.clientX, e.clientY);
            
            const flask = document.getElementById('clickTarget');
            // Check boosts for color
            if(Date.now() < GameState.hulkEndTime) flask.style.color = '#a855f7'; // Purple HULK
            else if(Date.now() < GameState.boostEndTime) flask.style.color = '#ef4444'; // Red Adrenaline
            else flask.style.color = '#22c55e'; 

            updateUI();
        }

        function createParticles(x, y) {
            for (let i = 0; i < 5; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                document.body.appendChild(p);
                p.style.left = x + 'px'; p.style.top = y + 'px';
                p.style.backgroundColor = Date.now() < GameState.boostEndTime ? '#fca5a5' : '#4ade80';
                
                const destX = (Math.random()-0.5)*100;
                const destY = (Math.random()-0.5)*100 - 50;
                
                const anim = p.animate([{transform:'translate(0,0)', opacity:1}, {transform:`translate(${destX}px, ${destY}px)`, opacity:0}], {duration: 600});
                anim.onfinish = () => p.remove();
            }
        }

        function createFloatingText(x, y, text, isCrit) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            if(isCrit) el.className += ' crit-text';
            el.innerText = text;
            el.style.left = (x + (Math.random()-0.5)*40) + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        window.buyUpgrade = function(type) {
            if (type === 'location' && GameState.locationLevel >= 4) return;
            let cost = 0;
            let level = 1;
            if(type==='multitap') level = GameState.multitapLevel;
            if(type==='energy') level = GameState.energyLevel;
            if(type==='recharge') level = GameState.rechargeLevel;
            if(type==='autobot') level = GameState.autobotLevel+1;
            if(type==='location') level = GameState.locationLevel+1;
            
            cost = Math.floor(Upgrades[type].baseCost * Math.pow(Upgrades[type].costMultiplier, level - 1));

            if (GameState.balance >= cost) {
                GameState.balance -= cost;
                if(type==='multitap') GameState.multitapLevel++;
                if(type==='energy') { GameState.energyLevel++; GameState.maxEnergy+=500; GameState.energy=GameState.maxEnergy; }
                if(type==='recharge') { GameState.rechargeLevel++; GameState.energyRechargeRate+=1; }
                if(type==='autobot') GameState.autobotLevel++;
                if(type==='location') { GameState.locationLevel++; showToast("–ü–ï–†–ï–ï–ó–î –£–°–ü–ï–®–ï–ù!"); }
                
                recalcMultiplier();
                saveGame();
                updateUI();
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                showToast("–ù–ï –•–í–ê–¢–ê–ï–¢!");
            }
        };

        window.buyItem = function(key) {
            if(GameState.items[key]) return;
            const cost = SpecialItems[key].cost;
            if(GameState.balance >= cost) {
                GameState.balance -= cost;
                GameState.items[key] = true;
                recalcMultiplier();
                saveGame();
                updateUI();
                tg.HapticFeedback.notificationOccurred('success');
            }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        }

        function switchTab(tab) {
            const tabs = ['upgrades', 'synthesis', 'casino', 'blackmarket'];
            tabs.forEach(t => {
                const btn = document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1));
                const content = document.getElementById('content'+t.charAt(0).toUpperCase()+t.slice(1));
                if (t === tab) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.add('tab-inactive');
                    btn.classList.remove('tab-active');
                    content.classList.add('hidden');
                }
            });
            if(tab !== 'synthesis') {
                const flasks = document.querySelectorAll('.draggable-flask');
                flasks.forEach(f => f.style.transform = '');
            }
        }

        // --- Loop ---
        setInterval(() => {
            if (GameState.energy < GameState.maxEnergy) {
                GameState.energy += GameState.energyRechargeRate;
                if(GameState.energy > GameState.maxEnergy) GameState.energy = GameState.maxEnergy;
            }
            if (GameState.autobotLevel > 0) {
                GameState.balance += GameState.autobotLevel * Upgrades.autobot.powerBase * GameState.multiplier;
            }
            // Check Boost Expiries
            let dirty = false;
            if (GameState.boostEndTime > 0 && Date.now() > GameState.boostEndTime) {
                GameState.boostEndTime = 0;
                dirty = true;
            }
            if (GameState.hulkEndTime > 0 && Date.now() > GameState.hulkEndTime) {
                GameState.hulkEndTime = 0;
                dirty = true;
            }
            if (dirty) recalcMultiplier();

            checkSmuggler(); // Check if smuggler should appear/disappear
            updateUI();
            if(Date.now() - GameState.lastSaveTime > 5000) saveGame();
        }, 1000);

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = Math.floor(GameState.balance).toLocaleString();
            document.getElementById('energyText').innerText = Math.floor(GameState.energy) + " / " + GameState.maxEnergy;
            document.getElementById('energyBar').style.width = (GameState.energy/GameState.maxEnergy*100) + "%";
            
            // Boost UI
            const isHulk = Date.now() < GameState.hulkEndTime;
            const isAdrenaline = Date.now() < GameState.boostEndTime;
            
            let multText = "–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x" + GameState.multiplier;
            if(isHulk) multText += " (HULK!)";
            else if(isAdrenaline) multText += " (BOOST)";
            
            document.getElementById('multiplierDisplay').innerText = multText;
            
            const boostTimer = document.getElementById('boostTimer');
            if (isHulk) {
                boostTimer.classList.remove('hidden');
                boostTimer.className = "text-xs text-purple-500 font-bold mt-1 animate-pulse";
                const secLeft = Math.ceil((GameState.hulkEndTime - Date.now())/1000);
                boostTimer.innerText = "–°–ò–õ–ê –•–ê–õ–ö–ê: " + secLeft + "s";
            } else if (isAdrenaline) {
                boostTimer.classList.remove('hidden');
                boostTimer.className = "text-xs text-red-500 font-bold mt-1 animate-pulse";
                const secLeft = Math.ceil((GameState.boostEndTime - Date.now())/1000);
                boostTimer.innerText = "–ê–î–†–ï–ù–ê–õ–ò–ù: " + secLeft + "s";
            } else {
                boostTimer.classList.add('hidden');
            }

            // Casino Timer
            const diff = Date.now() - GameState.lastSpinTime;
            const spinBtn = document.getElementById('btnSpin');
            const spinTimer = document.getElementById('spinTimer');
            if (diff >= 86400000) {
                spinBtn.disabled = false;
                spinBtn.style.opacity = 1;
                spinBtn.innerText = "–ö–†–£–¢–ò–¢–¨";
                spinTimer.classList.add('hidden');
            } else {
                spinBtn.disabled = true;
                spinBtn.style.opacity = 0.5;
                spinBtn.innerText = "–ñ–î–ò";
                spinTimer.classList.remove('hidden');
                const left = 86400000 - diff;
                const h = Math.floor(left/3600000);
                const m = Math.floor((left%3600000)/60000);
                const s = Math.floor((left%60000)/1000);
                document.getElementById('spinTimeVal').innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            }

            // Synthesis Cooldown
            const coolOverlay = document.getElementById('synthesisCooldown');
            if (Date.now() < GameState.synthesisCooldown) {
                coolOverlay.classList.remove('hidden');
                const min = Math.floor((GameState.synthesisCooldown - Date.now()) / 60000);
                const sec = Math.floor(((GameState.synthesisCooldown - Date.now()) % 60000) / 1000);
                document.getElementById('cooldownTimer').innerText = `${min}:${sec < 10 ? '0'+sec : sec}`;
            } else {
                coolOverlay.classList.add('hidden');
            }
            
            const getCost = (t, l) => Math.floor(Upgrades[t].baseCost * Math.pow(Upgrades[t].costMultiplier, l-1));
            
            document.getElementById('costMultitap').innerText = getCost('multitap', GameState.multitapLevel) + " –º–≥";
            document.getElementById('lvlMultitap').innerText = GameState.multitapLevel;
            document.getElementById('costEnergy').innerText = getCost('energy', GameState.energyLevel) + " –º–≥";
            document.getElementById('lvlEnergy').innerText = GameState.energyLevel;
            document.getElementById('costRecharge').innerText = getCost('recharge', GameState.rechargeLevel) + " –º–≥";
            document.getElementById('lvlRecharge').innerText = GameState.rechargeLevel;
            document.getElementById('costAutobot').innerText = getCost('autobot', GameState.autobotLevel+1) + " –º–≥";
            document.getElementById('lvlAutobot').innerText = GameState.autobotLevel;

            if(GameState.locationLevel >= 4) {
                 document.getElementById('costLocation').innerText = "–ú–ê–ö–°";
                 document.getElementById('nextLocName').innerText = "–ö–û–°–ú–û–°";
            } else {
                 document.getElementById('costLocation').innerText = getCost('location', GameState.locationLevel+1) + " –º–≥";
                 document.getElementById('nextLocName').innerText = LocationNames[GameState.locationLevel+1];
            }
            document.getElementById('levelDisplay').innerText = LocationNames[GameState.locationLevel];

            if (currentBgLevel !== GameState.locationLevel) {
                const body = document.getElementById('gameBody');
                if(currentBgLevel >= 0) body.classList.remove(`bg-lvl-${currentBgLevel}`);
                body.classList.add(`bg-lvl-${GameState.locationLevel}`);
                currentBgLevel = GameState.locationLevel;
            }

            const updateItem = (key, btnId, costId, statId) => {
                 if(GameState.items[key]) {
                     document.getElementById(costId).parentElement.style.display='none';
                     document.getElementById(statId).classList.remove('hidden');
                     document.getElementById(btnId).style.opacity = '0.5';
                 }
            };
            updateItem('unstableIsotope', 'btnIsotope', 'costIsotope', 'statusIsotope');
            updateItem('blueCrystal', 'btnCrystal', 'costCrystal', 'statusCrystal');
            updateItem('darkMatter', 'btnDarkMatter', 'costDarkMatter', 'statusDarkMatter');
        }

        initTelegram();
        loadGame();

    </script>
</body>
  </html>
